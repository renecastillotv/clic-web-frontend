---
// src/components/PropertyList.astro - VERSIÃ“N MEJORADA
export interface Props {
  listings: Array<{
    id?: string | number;
    slug: string;
    titulo: string;
    precio: string;
    imagen: string;
    imagenes?: string[];
    sector: string;
    habitaciones: number;
    banos: number;
    metros?: number;
    metros_terreno?: number;
    amenity_badges?: Array<{
      text: string;
      icon: string;
      category: string;
    }>;
    tipo?: string;
    url?: string;
    code?: string;
    isFormattedByProvider?: boolean;
    is_project?: boolean;
    project_badges?: string[];
    habitaciones_rango?: string;
    banos_rango?: string;
    metros_rango?: string;
    reserva_desde?: string;
    // Campos adicionales de la API
    built_area?: number;
    land_area?: number;
    parking_spots?: number;
    parqueos?: number;
    bedrooms?: number;
    bathrooms?: number;
    nivel?: number;
  }>;
  meta: {
    title: string;
    description: string;
  };
  totalCount?: number;
  currentPage?: number;
  totalPages?: number;
  itemsPerPage?: number;
  hasNextPage?: boolean;
  hasPreviousPage?: boolean;
  language?: 'es' | 'en' | 'fr';
  maxColumns?: 3 | 4; // Nueva prop para controlar columnas mÃ¡ximas
}

const {
  listings,
  meta,
  totalCount,
  currentPage = 1,
  totalPages = 1,
  itemsPerPage = 32,
  hasNextPage = false,
  hasPreviousPage = false,
  language = 'es',
  maxColumns = 4 // Por defecto 4 columnas
} = Astro.props;

// Traducciones para textos estÃ¡ticos
const translations = {
  es: {
    showing: "Mostrando",
    of: "de",
    propertiesFound: "propiedades encontradas",
    sortBy: "Ordenar por:",
    mostRecent: "MÃ¡s recientes",
    priceLowToHigh: "Precio: menor a mayor",
    priceHighToLow: "Precio: mayor a menor",
    moreRooms: "MÃ¡s habitaciones",
    noProperties: "No se encontraron propiedades",
    noPropertiesText: "No hay propiedades que coincidan con tu bÃºsqueda actual.",
    noPropertiesSubtext: "Encuentra mÃ¡s opciones y contenido interesante mÃ¡s abajo",
    previous: "Anterior",
    next: "Siguiente",
    addToFavorites: "Agregar a favoritos",
    reference: "ref.:",
    reserve: "Reserva",
    propertyWithoutName: "Propiedad sin nombre",
    priceToConsult: "Precio a consultar",
    locationNotSpecified: "UbicaciÃ³n no especificada",
    property: "Propiedad"
  },
  en: {
    showing: "Showing",
    of: "of",
    propertiesFound: "properties found",
    sortBy: "Sort by:",
    mostRecent: "Most recent",
    priceLowToHigh: "Price: low to high",
    priceHighToLow: "Price: high to low",
    moreRooms: "More bedrooms",
    noProperties: "No properties found",
    noPropertiesText: "There are no properties matching your current search.",
    noPropertiesSubtext: "Find more options and interesting content below",
    previous: "Previous",
    next: "Next",
    addToFavorites: "Add to favorites",
    reference: "ref.:",
    reserve: "Reserve",
    propertyWithoutName: "Property without name",
    priceToConsult: "Price on request",
    locationNotSpecified: "Location not specified",
    property: "Property"
  },
  fr: {
    showing: "Affichage",
    of: "de",
    propertiesFound: "propriÃ©tÃ©s trouvÃ©es",
    sortBy: "Trier par:",
    mostRecent: "Plus rÃ©cent",
    priceLowToHigh: "Prix: croissant",
    priceHighToLow: "Prix: dÃ©croissant",
    moreRooms: "Plus de chambres",
    noProperties: "Aucune propriÃ©tÃ© trouvÃ©e",
    noPropertiesText: "Aucune propriÃ©tÃ© ne correspond Ã  votre recherche actuelle.",
    noPropertiesSubtext: "Trouvez plus d'options et de contenu intÃ©ressant ci-dessous",
    previous: "PrÃ©cÃ©dent",
    next: "Suivant",
    addToFavorites: "Ajouter aux favoris",
    reference: "rÃ©f.:",
    reserve: "RÃ©server",
    propertyWithoutName: "PropriÃ©tÃ© sans nom",
    priceToConsult: "Prix sur demande",
    locationNotSpecified: "Emplacement non spÃ©cifiÃ©",
    property: "PropriÃ©tÃ©"
  }
};

// Obtener las traducciones para el idioma actual
const t = translations[language] || translations.es;

// FunciÃ³n mejorada para limpiar valores de rango
function cleanRangeValue(value: string): string {
  if (!value) return '';
  
  // Lista exhaustiva de palabras a eliminar
  const wordsToRemove = [
    // EspaÃ±ol
    'hab', 'habitaciÃ³n', 'habitaciones', 'cuarto', 'cuartos', 'dormitorio', 'dormitorios',
    'baÃ±o', 'baÃ±os', 'sanitario', 'sanitarios',
    'metro', 'metros', 'mÂ²', 'mts', 'mt2', 'metros cuadrados',
    // InglÃ©s
    'bed', 'beds', 'bedroom', 'bedrooms', 'room', 'rooms',
    'bath', 'baths', 'bathroom', 'bathrooms', 'restroom', 'restrooms',
    'sqft', 'sq ft', 'square feet', 'square foot',
    // FrancÃ©s
    'chambre', 'chambres', 'piÃ¨ce', 'piÃ¨ces',
    'salle de bain', 'salles de bain', 'bain', 'bains',
    'mÃ¨tre', 'mÃ¨tres', 'mÃ¨tres carrÃ©s',
    // Palabras adicionales problemÃ¡ticas
    'capÃ­tulo', 'capitulo', 'cap', 'chapter', 'chap'
  ];
  
  // Crear regex dinÃ¡mico
  const regex = new RegExp(
    '\\b(' + wordsToRemove.join('|') + ')s?\\b',
    'gi'
  );
  
  // Limpiar el valor
  let cleaned = value
    .replace(regex, '')
    .replace(/[^\d\-â€”â€“\s]/g, '') // Solo mantener nÃºmeros, guiones y espacios
    .replace(/\s+/g, ' ')
    .trim();
  
  return cleaned;
}

// Procesar listados
const processedListings = listings.map(property => {
  if (property.isFormattedByProvider) {
    return property;
  }
  
  return {
    ...property,
    titulo: property.titulo || t.propertyWithoutName,
    precio: property.precio || t.priceToConsult,
    imagen: property.imagen || 'https://via.placeholder.com/400x300/e5e7eb/9ca3af?text=Sin+Imagen',
    imagenes: property.imagenes || [property.imagen || 'https://via.placeholder.com/400x300/e5e7eb/9ca3af?text=Sin+Imagen'],
    sector: property.sector || t.locationNotSpecified,
    habitaciones: property.habitaciones || 0,
    banos: property.banos || 0,
    metros: property.metros || 0,
    tipo: property.tipo || t.property
  };
});

// ParÃ¡metros de la URL
const url = Astro.url;
const orden = url.searchParams.get('orden') || 'fecha-desc';

// Para sorting local (solo si es necesario)
function precioToNumber(precioStr: string): number {
  return parseFloat(precioStr.replace(/[USD$RD$,\s]/g, '')) || 0;
}

function sortListings(listings: typeof processedListings, orden: string) {
  const sorted = [...listings];
  
  switch (orden) {
    case 'precio-asc':
      return sorted.sort((a, b) => precioToNumber(a.precio) - precioToNumber(b.precio));
    case 'precio-desc':
      return sorted.sort((a, b) => precioToNumber(b.precio) - precioToNumber(a.precio));
    case 'habitaciones-desc':
      return sorted.sort((a, b) => b.habitaciones - a.habitaciones);
    case 'fecha-desc':
    default:
      return sorted;
  }
}

// Solo hacer sorting local si la API no lo hizo
const displayListings = orden === 'fecha-desc' ? processedListings : sortListings(processedListings, orden);

// USAR DATOS REALES DE LA API
const realTotalCount = totalCount || listings.length;
const realCurrentPage = currentPage;
const realTotalPages = totalPages;
const startIndex = ((realCurrentPage - 1) * itemsPerPage) + 1;
const endIndex = Math.min(realCurrentPage * itemsPerPage, realTotalCount);

// Variable para determinar si hay propiedades
const hasProperties = displayListings.length > 0;

function buildUrl(page: number, currentOrden: string): string {
  const params = new URLSearchParams();
  if (currentOrden !== 'fecha-desc') params.set('orden', currentOrden);
  if (page !== 1) params.set('page', page.toString());
  
  const paramString = params.toString();
  return paramString ? `?${paramString}` : '';
}

function getPaginationPages(current: number, total: number): (number | string)[] {
  const pages: (number | string)[] = [];
  const showPages = 5;
  
  if (total <= showPages) {
    for (let i = 1; i <= total; i++) {
      pages.push(i);
    }
  } else {
    if (current <= 3) {
      for (let i = 1; i <= Math.min(showPages, total); i++) {
        pages.push(i);
      }
      if (total > showPages) pages.push('...');
    } else if (current >= total - 2) {
      pages.push(1);
      if (total > showPages) pages.push('...');
      for (let i = Math.max(1, total - showPages + 1); i <= total; i++) {
        pages.push(i);
      }
    } else {
      pages.push(1);
      pages.push('...');
      for (let i = current - 1; i <= current + 1; i++) {
        pages.push(i);
      }
      pages.push('...');
      pages.push(total);
    }
  }
  
  return pages;
}

const paginationPages = getPaginationPages(realCurrentPage, realTotalPages);
---

<div class="container mx-auto px-4 py-8">
  <!-- Resumen de resultados y ordenamiento - SOLO SI HAY PROPIEDADES -->
  {hasProperties && (
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
      <div class="text-sm text-gray-600">
        {t.showing} {startIndex}â€“{endIndex} {t.of} {realTotalCount.toLocaleString()} {t.propertiesFound}
      </div>
      
      <div class="flex items-center gap-2">
        <label for="sort-select" class="text-sm text-gray-700 whitespace-nowrap">
          {t.sortBy}
        </label>
        <select 
          id="sort-select" 
          class="text-sm border border-gray-300 rounded-md px-3 py-1 shadow-sm focus:outline-none focus:ring-2 focus:ring-[#f04e00] focus:border-[#f04e00]"
        >
          <option value="fecha-desc" {orden === 'fecha-desc' ? 'selected' : ''}>
            {t.mostRecent}
          </option>
          <option value="precio-asc" {orden === 'precio-asc' ? 'selected' : ''}>
            {t.priceLowToHigh}
          </option>
          <option value="precio-desc" {orden === 'precio-desc' ? 'selected' : ''}>
            {t.priceHighToLow}
          </option>
          <option value="habitaciones-desc" {orden === 'habitaciones-desc' ? 'selected' : ''}>
            {t.moreRooms}
          </option>
        </select>
      </div>
    </div>
  )}

  <!-- Mensaje mejorado cuando no hay propiedades -->
  {!hasProperties && (
    <div class="flex items-center justify-center py-6 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border border-gray-200">
      <div class="flex items-center gap-4 text-center max-w-4xl">
        <div class="flex-shrink-0">
          <i class="fas fa-search-minus text-3xl text-gray-400"></i>
        </div>
        <div class="text-left">
          <h3 class="text-lg font-semibold text-gray-800 mb-1">{t.noProperties}</h3>
          <p class="text-gray-600 text-sm mb-0.5">
            {t.noPropertiesText}
          </p>
          <p class="text-gray-500 text-xs">
            {t.noPropertiesSubtext}
          </p>
        </div>
      </div>
    </div>
  )}

  <!-- Grid de propiedades -->
  {hasProperties && (
    <div class={`grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 ${maxColumns === 4 ? 'xl:grid-cols-4' : ''} gap-4`}>
      {displayListings.map((property, index) => {
        const propertyImages = property.imagenes || [property.imagen];
        const hasMultipleImages = propertyImages.length > 1;
        
        return (
          <a 
            href={property.url || '#'}
            class="group cursor-pointer"
            data-property-id={property.id || index}
          >
            <article class="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden transition-all duration-200 hover:shadow-lg hover:-translate-y-1">
              <!-- Imagen con carousel -->
              <div class="relative aspect-[16/9] overflow-hidden bg-gray-200">
                <!-- Contenedor de imÃ¡genes -->
                <div 
                  class="carousel-container w-full h-full relative"
                  data-carousel={index}
                >
                  {propertyImages.map((img, imgIndex) => (
                    <img
                      src={img || 'https://via.placeholder.com/400x300/e5e7eb/9ca3af?text=Sin+Imagen'}
                      alt={`${property.titulo} - ${language === 'es' ? 'Imagen' : language === 'en' ? 'Image' : 'Image'} ${imgIndex + 1}`}
                      width="800"
                      height="450"
                      class={`carousel-image absolute inset-0 w-full h-full object-cover transition-all duration-300 ${imgIndex === 0 ? 'opacity-100 scale-100' : 'opacity-0 scale-105'}`}
                      data-index={imgIndex}
                      data-carousel={index}
                      loading={imgIndex === 0 ? "eager" : "lazy"}
                      onerror="this.src='https://via.placeholder.com/400x300/e5e7eb/9ca3af?text=Sin+Imagen';"
                    />
                  ))}
                </div>
                
                <!-- Controles de navegaciÃ³n -->
                {hasMultipleImages && (
                  <div class="carousel-controls absolute inset-0 flex items-center justify-between p-3 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <button 
                      class="carousel-prev w-7 h-7 rounded-full bg-black/40 hover:bg-black/60 shadow-sm flex items-center justify-center transition-colors z-10"
                      data-carousel={index}
                      type="button"
                    >
                      <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"></path>
                      </svg>
                    </button>
                    
                    <button 
                      class="carousel-next w-7 h-7 rounded-full bg-black/40 hover:bg-black/60 shadow-sm flex items-center justify-center transition-colors z-10"
                      data-carousel={index}
                      type="button"
                    >
                      <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
                      </svg>
                    </button>
                  </div>
                )}
                
                <!-- Indicadores de imagen -->
                {hasMultipleImages && (
                  <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 flex gap-1">
                    {propertyImages.map((_, dotIndex) => (
                      <div 
                        class={`carousel-dot w-1.5 h-1.5 rounded-full transition-all duration-200 ${dotIndex === 0 ? 'bg-white/90' : 'bg-white/40'}`}
                        data-carousel={index}
                        data-dot={dotIndex}
                      ></div>
                    ))}
                  </div>
                )}
                
                <!-- Badge de reserva/tipo -->
                {property.is_project && property.reserva_desde ? (
                  <span class="absolute top-3 left-3 bg-gray-700/90 text-white px-2 py-1 rounded text-xs font-medium shadow-sm">
                    {t.reserve} {property.reserva_desde}
                  </span>
                ) : property.tipo && property.tipo !== t.property && (
                  <span class="absolute top-3 left-3 bg-white/80 text-gray-700 px-2 py-1 rounded text-xs font-medium shadow-sm">
                    {property.tipo}
                  </span>
                )}
                
                <!-- Badges de proyecto -->
                {property.is_project && property.project_badges && property.project_badges.length > 0 && (
                  <div class="absolute top-10 left-3 flex flex-wrap gap-1">
                    {property.project_badges.slice(0, 2).map((badge, idx) => (
                      <span key={idx} class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-white/80 text-gray-700 shadow-sm">
                        {badge}
                      </span>
                    ))}
                  </div>
                )}
                
                <!-- BotÃ³n de favoritos -->
                <button 
                  class="absolute top-3 right-3 p-2 rounded-full bg-white/90 hover:bg-white transition-colors shadow-md z-20"
                  aria-label={t.addToFavorites}
                  onclick={`event.preventDefault(); event.stopPropagation(); toggleFavorite('${property.id || index}', '${property.titulo.replace(/'/g, "\\'")}');`}
                  data-favorite-id={property.id || index}
                >
                  <svg class="w-4 h-4 text-gray-600 hover:text-red-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                  </svg>
                </button>
              </div>
              
              <!-- Contenido -->
              <div class="p-3">
                <!-- CÃ³digo de referencia y Precio -->
                <div class="flex justify-between items-center mb-1.5">
                  {property.code && (
                    <div class="text-xs text-gray-400 font-mono">
                      {t.reference} {property.code}
                    </div>
                  )}
                  <div class="text-base font-bold text-[#f04e00] ml-auto">
                    {property.precio}
                  </div>
                </div>
                
                <!-- UbicaciÃ³n -->
                <div class="flex items-center gap-1 mb-1.5">
                  <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                  <p class="text-sm text-gray-600 truncate">{property.sector}</p>
                </div>

                <!-- TÃ­tulo -->
                <div class="h-10 flex items-center mb-2">
                  <h3 class="font-medium text-gray-800 line-clamp-2 group-hover:text-[#f04e00] transition-colors leading-snug">
                    {property.titulo}
                  </h3>
                </div>
                
                <!-- CaracterÃ­sticas - SOLO ICONOS Y NÃšMEROS -->
                <div class="flex items-center justify-center gap-4 text-gray-900">
                  {(property.bedrooms > 0 || property.habitaciones > 0 || (property.is_project && property.habitaciones_rango && !property.habitaciones_rango.includes('0') && cleanRangeValue(property.habitaciones_rango) !== '')) && (
                    <span class="flex items-center gap-1">
                      <i class="fas fa-bed text-[#f04e00] text-sm"></i>
                      <span class="font-semibold text-sm">
                        {property.is_project && property.habitaciones_rango ? 
                          cleanRangeValue(property.habitaciones_rango) : 
                          property.bedrooms || property.habitaciones
                        }
                      </span>
                    </span>
                  )}
                  
                  {(property.bathrooms > 0 || property.banos > 0 || (property.is_project && property.banos_rango && !property.banos_rango.includes('0') && cleanRangeValue(property.banos_rango) !== '')) && (
                    <span class="flex items-center gap-1">
                      <i class="fas fa-bath text-[#f04e00] text-sm"></i>
                      <span class="font-semibold text-sm">
                        {property.is_project && property.banos_rango ? 
                          cleanRangeValue(property.banos_rango) : 
                          property.bathrooms || property.banos
                        }
                      </span>
                    </span>
                  )}
                  
                  {((property.built_area > 0) || (property.land_area > 0) || (property.metros > 0) || (property.metros_terreno > 0) || (property.is_project && property.metros_rango && !property.metros_rango.includes('0') && cleanRangeValue(property.metros_rango) !== '')) && (
                    <span class="flex items-center gap-1">
                      <i class="fas fa-th-large text-[#f04e00] text-sm"></i>
                      <span class="font-semibold text-sm">
                        {property.is_project && property.metros_rango ? 
                          cleanRangeValue(property.metros_rango) + ' mÂ²' : 
                          property.built_area > 0 ? `${property.built_area.toLocaleString()} mÂ²` :
                          property.land_area > 0 ? `${property.land_area.toLocaleString()} mÂ²` :
                          property.metros_terreno > 0 ? `${property.metros_terreno.toLocaleString()} mÂ²` :
                          property.metros > 0 ? `${property.metros.toLocaleString()} mÂ²` : ''
                        }
                      </span>
                    </span>
                  )}
                  
                  {(property.nivel > 0) && (
                    <span class="flex items-center gap-1">
                      <i class="fas fa-layer-group text-[#f04e00] text-sm"></i>
                      <span class="font-semibold text-sm">
                        {property.nivel}
                      </span>
                    </span>
                  )}
                  
                  {(property.parking_spots > 0 || property.parqueos > 0) && (
                    <span class="flex items-center gap-1">
                      <i class="fas fa-car text-[#f04e00] text-sm"></i>
                      <span class="font-semibold text-sm">
                        {property.parking_spots || property.parqueos}
                      </span>
                    </span>
                  )}
                </div>
              </div>
            </article>
          </a>
        );
      })}
    </div>
  )}

  <!-- PaginaciÃ³n - SOLO SI HAY PROPIEDADES -->
  {hasProperties && realTotalPages > 1 && (
    <div class="mt-12 flex justify-center">
      <nav class="flex gap-2">
        {hasPreviousPage ? (
          <a 
            href={buildUrl(realCurrentPage - 1, orden)}
            class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
          >
            {t.previous}
          </a>
        ) : (
          <span class="px-4 py-2 border border-gray-200 rounded-md text-gray-400 cursor-not-allowed">
            {t.previous}
          </span>
        )}
        
        {paginationPages.map((page) => (
          page === '...' ? (
            <span class="px-4 py-2 text-gray-400">...</span>
          ) : page === realCurrentPage ? (
            <span class="px-4 py-2 bg-[#f04e00] text-white rounded-md">
              {page}
            </span>
          ) : (
            <a 
              href={buildUrl(page as number, orden)}
              class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
            >
              {page}
            </a>
          )
        ))}
        
        {hasNextPage ? (
          <a 
            href={buildUrl(realCurrentPage + 1, orden)}
            class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
          >
            {t.next}
          </a>
        ) : (
          <span class="px-4 py-2 border border-gray-200 rounded-md text-gray-400 cursor-not-allowed">
            {t.next}
          </span>
        )}
      </nav>
    </div>
  )}
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .carousel-image {
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
  }
  
  .carousel-controls {
    transition: opacity 0.2s ease-in-out;
  }
</style>

<script>
  // ===== PROPERTYLIST SIMPLIFICADO =====
  
  // Estado del carousel por propiedad
  const carouselStates = new Map();

  // ===== FUNCIONES DE CAROUSEL =====
  
  function navigateCarousel(carouselIndex, direction) {
    console.log('ðŸŽ¯ Navigating carousel:', carouselIndex, direction);
    
    const images = document.querySelectorAll(`[data-carousel="${carouselIndex}"].carousel-image`);
    const dots = document.querySelectorAll(`[data-carousel="${carouselIndex}"][data-dot]`);
    
    if (images.length <= 1) return;
    
    let currentIndex = carouselStates.get(carouselIndex) || 0;
    
    if (direction === 'next') {
      currentIndex = (currentIndex + 1) % images.length;
    } else {
      currentIndex = currentIndex === 0 ? images.length - 1 : currentIndex - 1;
    }
    
    carouselStates.set(carouselIndex, currentIndex);
    
    // Actualizar imÃ¡genes
    images.forEach((img, index) => {
      if (index === currentIndex) {
        img.classList.add('opacity-100', 'scale-100');
        img.classList.remove('opacity-0', 'scale-105');
      } else {
        img.classList.remove('opacity-100', 'scale-100');
        img.classList.add('opacity-0', 'scale-105');
      }
    });
    
    // Actualizar indicadores
    dots.forEach((dot, index) => {
      if (index === currentIndex) {
        dot.classList.add('bg-white/90');
        dot.classList.remove('bg-white/40');
      } else {
        dot.classList.remove('bg-white/90');
        dot.classList.add('bg-white/40');
      }
    });
  }

  // ===== FUNCIONES DE SORTING =====
  
  function handleSortChange(newOrder) {
    const currentUrl = new URL(window.location.href);
    
    if (newOrder === 'fecha-desc') {
      currentUrl.searchParams.delete('orden');
    } else {
      currentUrl.searchParams.set('orden', newOrder);
    }
    
    currentUrl.searchParams.delete('page');
    window.location.href = currentUrl.toString();
  }

  // ===== FUNCIONES DE FAVORITOS SIMPLIFICADAS =====
  
  async function toggleFavorite(propertyId, propertyTitle) {
    console.log('â¤ï¸ Toggle favorite:', propertyId, propertyTitle);
    
    if (!window.simpleFavoritesManager) {
      console.error('âŒ SimpleFavoritesManager not available');
      return;
    }

    try {
      // Actualizar UI inmediatamente
      const isCurrentlyFavorite = window.simpleFavoritesManager.isFavorite(propertyId);
      updateFavoriteButtonUI(propertyId, !isCurrentlyFavorite);
      
      // Llamar a la API
      await window.simpleFavoritesManager.toggleFavorite(propertyId);
      
      console.log(`âœ… Favorito ${isCurrentlyFavorite ? 'removido' : 'agregado'}:`, propertyTitle);
      
    } catch (error) {
      console.error('âŒ Error toggling favorite:', error);
      
      // Revertir UI en caso de error
      const currentState = window.simpleFavoritesManager.isFavorite(propertyId);
      updateFavoriteButtonUI(propertyId, currentState);
      
      alert('Error al actualizar favorito. IntÃ©ntalo de nuevo.');
    }
  }

  function updateFavoriteButtonUI(propertyId, isFavorite) {
    const button = document.querySelector(`[data-favorite-id="${propertyId}"]`);
    if (!button) return;
    
    const icon = button.querySelector('svg');
    if (!icon) return;
    
    if (isFavorite) {
      icon.setAttribute('fill', 'currentColor');
      icon.classList.remove('text-gray-600');
      icon.classList.add('text-red-500');
    } else {
      icon.setAttribute('fill', 'none');
      icon.classList.remove('text-red-500');
      icon.classList.add('text-gray-600');
    }
  }

  // ===== FUNCIÃ“N PARA ACTUALIZAR UI DESDE MANAGER EXTERNO =====
  
  function updatePropertyListUI(info) {
    // El manager pasa directamente el objeto info, no state
    if (!info || !info.favorites) return;
    
    console.log('ðŸ  PropertyList updating favorites UI:', info.favorites);
    
    // info.favorites es un Array, convertir a Set para usar .has()
    const favoritesSet = new Set(info.favorites);
    
    document.querySelectorAll('[data-favorite-id]').forEach(button => {
      const propertyId = button.getAttribute('data-favorite-id');
      const isFavorite = favoritesSet.has(propertyId);
      updateFavoriteButtonUI(propertyId, isFavorite);
    });
  }

  // ===== FUNCIÃ“N PARA SINCRONIZAR CON MANAGER =====
  
  function syncWithFavoritesManager() {
    if (window.simpleFavoritesManager) {
      try {
        const info = window.simpleFavoritesManager.getDeviceInfo();
        if (info) {
          updatePropertyListUI(info);
        }
      } catch (error) {
        console.error('âŒ Error sincronizando favoritos:', error);
      }
    }
  }

  // ===== FUNCIÃ“N PARA POLLING PERIÃ“DICO =====
  
  function startFavoritesSync() {
    // Sincronizar cada 2 segundos si hay manager disponible
    setInterval(() => {
      if (window.simpleFavoritesManager && !window._syncInProgress) {
        syncWithFavoritesManager();
      }
    }, 2000);
  }

  // ===== INICIALIZACIÃ“N =====
  
  document.addEventListener('DOMContentLoaded', async function() {
    console.log('ðŸŽ¬ Initializing PropertyList functionality');
    
    // Prevenir inicializaciÃ³n mÃºltiple
    if (window._propertyListInitialized) {
      console.log('âš¡ PropertyList ya inicializado, saltando...');
      return;
    }
    window._propertyListInitialized = true;
    
    try {
      // Esperar al SimpleFavoritesManager con polling
      let attempts = 0;
      const maxAttempts = 50;
      
      while (!window.simpleFavoritesManager && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      
      if (window.simpleFavoritesManager) {
        console.log('âœ… SimpleFavoritesManager encontrado');
        
        // Actualizar UI inicial si hay favoritos
        const info = window.simpleFavoritesManager.getDeviceInfo();
        if (info && info.count > 0) {
          updatePropertyListUI(info);
        }
        
        // Agregar listener para cambios
        window.simpleFavoritesManager.addListener(updatePropertyListUI);
        
        // Iniciar sincronizaciÃ³n periÃ³dica
        startFavoritesSync();
        
        console.log('âœ… SimpleFavoritesManager conectado a PropertyList');
      } else {
        console.log('âš¡ SimpleFavoritesManager no disponible despuÃ©s de esperar');
      }
    } catch (error) {
      console.error('âŒ Error conectando con SimpleFavoritesManager:', error);
    }
    
    // Inicializar carousels
    document.querySelectorAll('[data-carousel]').forEach(container => {
      const carouselIndex = container.getAttribute('data-carousel');
      if (carouselIndex !== null && !carouselStates.has(carouselIndex)) {
        carouselStates.set(carouselIndex, 0);
      }
    });
    
    // Event listeners para carousel
    document.addEventListener('click', function(event) {
      if (event.target.closest('.carousel-prev') || event.target.closest('.carousel-next')) {
        event.preventDefault();
        event.stopPropagation();
        
        const button = event.target.closest('.carousel-prev, .carousel-next');
        const carouselIndex = button.getAttribute('data-carousel');
        const direction = button.classList.contains('carousel-prev') ? 'prev' : 'next';
        
        if (carouselIndex !== null) {
          navigateCarousel(carouselIndex, direction);
        }
      }
    });
    
    // Event listener para sorting - SOLO SI EL ELEMENTO EXISTE
    const sortSelect = document.getElementById('sort-select');
    if (sortSelect) {
      sortSelect.addEventListener('change', function(event) {
        handleSortChange(event.target.value);
      });
    }
    
    console.log('âœ… PropertyList functionality initialized');
  });

  // ===== FUNCIONES GLOBALES =====
  
  window.handleSortChange = handleSortChange;
  window.toggleFavorite = toggleFavorite;
  window.navigateCarousel = navigateCarousel;
  window.updatePropertyListUI = updatePropertyListUI;
  window.syncWithFavoritesManager = syncWithFavoritesManager;
</script>