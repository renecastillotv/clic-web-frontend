---
// src/layouts/PropertyTypesLayout.astro
import Layout from './Layout.astro';
import PropertyCarousel from '../components/PropertyCarousel.astro';

/* Utils */
function safeArray(arr, def = []) { return Array.isArray(arr) ? arr : def; }
function safeString(str, def = '') { return typeof str === 'string' ? str : def; }
function safeObject(obj, def = {}) { return obj && typeof obj === 'object' && !Array.isArray(obj) ? obj : def; }
function safeNumber(num, def = 0) { return typeof num === 'number' && !isNaN(num) ? num : def; }

/* Props */
const { data } = Astro.props;
const language = safeString(data?.language, 'es');

/* Datos demo (luego vendr√°n del backend) */
const propertyTypesData = safeObject(data);

const propertyTypes = safeArray(propertyTypesData?.propertyTypes);
const featuredByType = safeObject(propertyTypesData?.featuredByType);

/* Traducciones */
const text = ({
  es: {
    metaTitle: 'Tipos de Propiedades | CLIC',
    metaDescription: 'Explora todos los tipos de propiedades disponibles: apartamentos, casas, villas, terrenos y m√°s',
    pageTitle: 'Tipos de Propiedades',
    pageSubtitle: 'Encuentra el inmueble perfecto para ti',
    viewAll: 'Ver todas',
    properties: 'propiedades',
    featured: 'Destacadas en',
    browseByType: 'Explora por Tipo',
    noTypes: 'No se encontraron tipos de propiedades.'
  },
  en: {
    metaTitle: 'Property Types | CLIC',
    metaDescription: 'Explore all available property types: apartments, houses, villas, land and more',
    pageTitle: 'Property Types',
    pageSubtitle: 'Find the perfect property for you',
    viewAll: 'View all',
    properties: 'properties',
    featured: 'Featured in',
    browseByType: 'Browse by Type',
    noTypes: 'No property types found.'
  },
  fr: {
    metaTitle: 'Types de Propri√©t√©s | CLIC',
    metaDescription: 'Explorez tous les types de propri√©t√©s disponibles : appartements, maisons, villas, terrains et plus',
    pageTitle: 'Types de Propri√©t√©s',
    pageSubtitle: 'Trouvez la propri√©t√© parfaite pour vous',
    viewAll: 'Voir tout',
    properties: 'propri√©t√©s',
    featured: 'En vedette dans',
    browseByType: 'Parcourir par Type',
    noTypes: 'Aucun type de propri√©t√© trouv√©.'
  }
})[language];

/* SEO */
const rawSeo = safeObject(propertyTypesData?.seo);
const safeSeo = {
  title: safeString(rawSeo.title) || text.metaTitle,
  description: safeString(rawSeo.description) || text.metaDescription,
  h1: safeString(rawSeo.h1) || text.pageTitle,
  h2: safeString(rawSeo.h2) || text.pageSubtitle,
  canonical_url: safeString(rawSeo.canonical_url, ''),
  ogImage: safeString(rawSeo.ogImage || rawSeo.open_graph?.image, '/og-property-types.jpg'),
  keywords: safeString(rawSeo.keywords),
  hreflang: safeObject(rawSeo.hreflang),
  breadcrumbs: safeArray(rawSeo.breadcrumbs, []),
  structured_data: safeObject(rawSeo.structured_data),
  open_graph: safeObject(rawSeo.open_graph),
  twitter_card: safeObject(rawSeo.twitter_card)
};

/* Layout props */
const layoutProps = {
  title: safeSeo.title,
  description: safeSeo.description,
  ogImage: safeSeo.ogImage,
  canonical: safeSeo.canonical_url,
  keywords: safeSeo.keywords,
  hreflangData: safeSeo.hreflang || {},
  globalConfig: propertyTypesData?.globalConfig || {},
  language,
  trackingString: propertyTypesData?.trackingString || '',
  hotItems: propertyTypesData?.hotItems || {},
  country: propertyTypesData?.country || {},
  breadcrumbs: safeSeo.breadcrumbs,
  structuredData: safeSeo.structured_data,
  openGraph: safeSeo.open_graph,
  twitterCard: safeSeo.twitter_card
};

/* Obtener datos reales del backend */
const enrichedTypesData = safeArray(propertyTypesData?.enrichedTypes);
const remainingTypesData = safeArray(propertyTypesData?.remainingTypes);
const typesData = safeArray(propertyTypes);

/* Fallback demo data solo si no hay datos del backend */
const demoPropertyTypes = [
  {
    type: language === 'es' ? 'Apartamentos' : language === 'en' ? 'Apartments' : 'Appartements',
    slug: language === 'es' ? 'apartamentos' : language === 'en' ? 'apartments' : 'appartements',
    count: 1234,
    icon: 'üè¢',
    description: language === 'es' ? 'Modernos espacios urbanos' : language === 'en' ? 'Modern urban spaces' : 'Espaces urbains modernes'
  },
  {
    type: language === 'es' ? 'Casas' : language === 'en' ? 'Houses' : 'Maisons',
    slug: language === 'es' ? 'casas' : language === 'en' ? 'houses' : 'maisons',
    count: 567,
    icon: 'üè†',
    description: language === 'es' ? 'Espacios familiares amplios' : language === 'en' ? 'Spacious family homes' : 'Maisons familiales spacieuses'
  },
  {
    type: language === 'es' ? 'Villas' : language === 'en' ? 'Villas' : 'Villas',
    slug: 'villas',
    count: 234,
    icon: 'üè∞',
    description: language === 'es' ? 'Lujo y exclusividad' : language === 'en' ? 'Luxury and exclusivity' : 'Luxe et exclusivit√©'
  },
  {
    type: language === 'es' ? 'Penthouses' : language === 'en' ? 'Penthouses' : 'Penthouses',
    slug: 'penthouses',
    count: 89,
    icon: 'üåÜ',
    description: language === 'es' ? 'Vistas panor√°micas √∫nicas' : language === 'en' ? 'Unique panoramic views' : 'Vues panoramiques uniques'
  },
  {
    type: language === 'es' ? 'Terrenos' : language === 'en' ? 'Land' : 'Terrains',
    slug: language === 'es' ? 'terrenos' : language === 'en' ? 'land' : 'terrains',
    count: 345,
    icon: 'üå≥',
    description: language === 'es' ? 'Inversi√≥n para desarrollo' : language === 'en' ? 'Investment for development' : 'Investissement pour d√©veloppement'
  },
  {
    type: language === 'es' ? 'Locales Comerciales' : language === 'en' ? 'Commercial Spaces' : 'Locaux Commerciaux',
    slug: language === 'es' ? 'locales-comerciales' : language === 'en' ? 'commercial-spaces' : 'locaux-commerciaux',
    count: 178,
    icon: 'üè™',
    description: language === 'es' ? 'Oportunidades de negocio' : language === 'en' ? 'Business opportunities' : 'Opportunit√©s d\'affaires'
  }
];

/* Usar datos reales si existen, sino demo */
const displayFeaturedTypes = enrichedTypesData.length > 0 ? enrichedTypesData : demoPropertyTypes.slice(0, 3);
const displayRemainingTypes = remainingTypesData.length > 0 ? remainingTypesData : demoPropertyTypes.slice(3);
const displayPropertyTypes = typesData.length > 0 ? typesData : demoPropertyTypes;
---

<Layout {...layoutProps}>
  <div class="property-types-layout">

    <!-- HERO -->
    <section class="py-16 bg-gradient-to-r from-gray-900 to-gray-800 text-white">
      <div class="container mx-auto px-4 text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">{safeSeo.h1}</h1>
        <p class="text-xl md:text-2xl opacity-90 max-w-3xl mx-auto">{safeSeo.h2}</p>
      </div>
    </section>

    <!-- TIPOS DESTACADOS CON IM√ÅGENES -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold mb-8 text-center">{text.browseByType}</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
          {displayFeaturedTypes.map(type => {
            const description = type.seo_description || type.description || '';
            const hasImage = type.hasEnrichedData && type.hero_image;

            return (
              <a
                href={`/${type.slug}`}
                class="group bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden hover:shadow-2xl hover:border-[#f04e00] transition-all duration-300 transform hover:-translate-y-2"
              >
                {/* Imagen si existe, sino gradiente con icono */}
                {hasImage ? (
                  <div class="aspect-[4/3] relative bg-gray-200">
                    <img
                      src={type.hero_image}
                      alt={type.type}
                      class="w-full h-full object-cover"
                      loading="lazy"
                    />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>

                    <div class="absolute bottom-0 left-0 right-0 p-6 text-white">
                      <h3 class="text-2xl font-bold mb-2">{type.type}</h3>
                      <p class="text-sm opacity-90 font-semibold">{type.count} {text.properties}</p>
                      {description && (
                        <p class="text-xs opacity-90 mt-2 line-clamp-2">{description}</p>
                      )}
                    </div>
                  </div>
                ) : (
                  <div class={`aspect-[4/3] relative ${type.color ? '' : 'bg-gradient-to-br from-orange-500 to-red-600'}`}
                       style={type.color ? `background: linear-gradient(135deg, ${type.color}22, ${type.color}66)` : ''}>

                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>

                    <div class="absolute bottom-0 left-0 right-0 p-6 text-white">
                      <h3 class="text-2xl font-bold mb-2">{type.type}</h3>
                      <p class="text-sm opacity-90 font-semibold">{type.count} {text.properties}</p>
                      {description && (
                        <p class="text-xs opacity-75 mt-2 line-clamp-2">{description}</p>
                      )}
                    </div>
                  </div>
                )}
              </a>
            );
          })}
        </div>

        <!-- OTROS TIPOS (estilo sectores) -->
        {displayRemainingTypes.length > 0 && (
          <div>
            <h3 class="text-2xl font-bold mb-6 text-center">{language === 'es' ? 'Otras Categor√≠as' : language === 'en' ? 'Other Categories' : 'Autres Cat√©gories'}</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              {displayRemainingTypes.map(type => (
                <a
                  href={`/${type.slug}`}
                  class="bg-white rounded-lg shadow-sm border border-gray-100 p-6 hover:shadow-lg hover:border-[#f04e00] transition-all duration-300 group"
                >
                  <div class="mb-3">
                    <h3 class="text-xl font-bold group-hover:text-[#f04e00] transition-colors">{type.type}</h3>
                  </div>

                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                      </svg>
                      <span class="text-sm font-semibold text-gray-700">{type.count} {text.properties}</span>
                    </div>
                    <svg class="w-5 h-5 text-[#f04e00] transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                  </div>
                </a>
              ))}
            </div>
          </div>
        )}
      </div>
    </section>

    <!-- CAROUSELES POR TIPO (si hay datos) -->
    {featuredByType && Object.keys(featuredByType).length > 0 && (
      <div class="bg-gray-50">
        {Object.entries(featuredByType).map(([typeName, properties]) => {
          // Buscar el slug correcto del tipo
          const typeInfo = displayPropertyTypes.find(t => t.type === typeName);
          const typeSlug = typeInfo?.slug || typeName.toLowerCase().replace(/\s+/g, '-');

          return properties && properties.length > 0 && (
            <section class="py-8">
              <PropertyCarousel
                title={`${text.featured} ${typeName}`}
                properties={properties}
                viewAllLink={`/${typeSlug}`}
                theme="default"
                language={language}
                country={propertyTypesData?.country}
                loadingStrategy="lazy"
                maxVisible={6}
              />
            </section>
          );
        })}
      </div>
    )}

    <!-- CTA -->
    <section class="py-16 bg-gradient-to-r from-[#f04e00] to-[#e03d00] text-white">
      <div class="container mx-auto px-4 text-center">
        <h3 class="text-3xl font-bold mb-4">
          {language === 'es' ? '¬øBuscas algo espec√≠fico?' :
           language === 'en' ? 'Looking for something specific?' :
           'Vous cherchez quelque chose de sp√©cifique?'}
        </h3>
        <p class="text-lg opacity-90 mb-8 max-w-2xl mx-auto">
          {language === 'es' ? 'Nuestros asesores expertos te ayudar√°n a encontrar exactamente lo que necesitas' :
           language === 'en' ? 'Our expert advisors will help you find exactly what you need' :
           'Nos conseillers experts vous aideront √† trouver exactement ce dont vous avez besoin'}
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a
            href="/contacto"
            class="inline-flex items-center justify-center px-8 py-3 bg-white text-[#f04e00] font-semibold rounded-lg hover:bg-gray-100 transition-all duration-300 transform hover:scale-105"
          >
            {language === 'es' ? 'Contactar Asesor' :
             language === 'en' ? 'Contact Advisor' :
             'Contacter Conseiller'}
          </a>
          <a
            href="/"
            class="inline-flex items-center justify-center px-8 py-3 border-2 border-white text-white font-semibold rounded-lg hover:bg-white hover:text-[#f04e00] transition-all duration-300 transform hover:scale-105"
          >
            {language === 'es' ? 'Ver Todas las Propiedades' :
             language === 'en' ? 'View All Properties' :
             'Voir Toutes les Propri√©t√©s'}
          </a>
        </div>
      </div>
    </section>

  </div>

  <!-- Structured Data -->
  {safeSeo.structured_data && (
    <script type="application/ld+json" set:html={JSON.stringify(safeSeo.structured_data)}></script>
  )}
</Layout>
