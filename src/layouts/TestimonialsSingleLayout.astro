---
// src/layouts/TestimonialsSingleLayout.astro - Layout para testimonio individual con contenido cruzado
import Layout from './Layout.astro';

// ===================================================================
// FUNCIONES HELPER DE VALIDACIÓN
// ===================================================================

const safeArray = (arr) => Array.isArray(arr) ? arr : [];
const safeObject = (obj) => obj && typeof obj === 'object' ? obj : {};
const safeString = (str) => typeof str === 'string' ? str : '';
const safeNumber = (num) => typeof num === 'number' && !isNaN(num) ? num : 0;
const safeBool = (bool) => Boolean(bool);

function stripHtml(html) {
  if (!html) return '';
  const text = html.replace(/<[^>]*>/g, '');
  const decoded = text.replace(/&nbsp;/g, ' ').replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');
  return decoded.trim();
}

// ===================================================================
// EXTRACCIÓN DE DATOS DEL PROP
// ===================================================================

const { data } = Astro.props;
const language = data?.language || 'es';

// ===================================================================
// PROCESAMIENTO DEFENSIVO DE DATOS
// ===================================================================

const rawTestimonial = safeObject(data?.testimonial);
const currentTestimonial = {
  id: safeString(rawTestimonial.id),
  title: safeString(rawTestimonial.title) || 'Testimonio',
  excerpt: safeString(rawTestimonial.excerpt) || 'Historia de éxito',
  fullTestimonial: safeString(rawTestimonial.fullTestimonial) || '',
  rating: safeNumber(rawTestimonial.rating) || 5,
  clientName: safeString(rawTestimonial.clientName) || 'Cliente',
  clientAvatar: safeString(rawTestimonial.clientAvatar) || '/images/default-avatar.jpg',
  clientLocation: safeString(rawTestimonial.clientLocation) || 'República Dominicana',
  clientVerified: safeBool(rawTestimonial.clientVerified),
  featuredImage: safeString(rawTestimonial.featuredImage),
  publishedAt: safeString(rawTestimonial.publishedAt) || new Date().toISOString(),
  url: safeString(rawTestimonial.url) || '#',
  agent: safeObject(rawTestimonial.agent, {
    name: 'Equipo CLIC',
    avatar: '/images/team/clic-experts.jpg',
    position: 'Asesor Inmobiliario',
    url: null
  })
};

// Categoría
const rawCategory = safeObject(data?.category);
const categoryInfo = {
  name: safeString(rawCategory.name) || 'Testimonios',
  slug: safeString(rawCategory.slug) || 'testimonios'
};

// Contenido cruzado
const safeRelatedVideos = safeArray(data?.crossContent?.videos || data?.relatedVideos).map((video, index) => ({
  id: safeString(video.id, `video-${index}`),
  title: safeString(video.title, 'Video relacionado'),
  thumbnail: safeString(video.thumbnail, 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=400&h=300&fit=crop'),
  duration: safeString(video.duration, '0:00'),
  views: safeNumber(video.views, 0),
  url: safeString(video.url, '#'),
  author: safeObject(video.author, { name: 'CLIC', avatar: '/images/team/clic-experts.jpg' })
}));

const safeRelatedArticles = safeArray(data?.crossContent?.articles || data?.relatedArticles).map((article, index) => ({
  id: safeString(article.id, `article-${index}`),
  title: safeString(article.title, 'Artículo relacionado'),
  excerpt: safeString(article.excerpt, 'Extracto no disponible'),
  featuredImage: safeString(article.featuredImage || article.image, 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=400&h=300&fit=crop'),
  url: safeString(article.url, '#'),
  publishedAt: safeString(article.publishedAt, new Date().toISOString()),
  readTime: safeString(article.readTime, '5 min'),
  views: safeNumber(article.views, 0),
  author: safeObject(article.author, { name: 'CLIC', avatar: currentTestimonial.agent.avatar })
}));

const safeRelatedProperties = safeArray(data?.crossContent?.properties || data?.relatedProperties).map((property, index) => ({
  id: safeString(property.id, `property-${index}`),
  name: safeString(property.name, 'Propiedad disponible'),
  price: safeString(property.price, 'Consultar'),
  image: safeString(property.image, 'https://images.unsplash.com/photo-1613490493576-7fde63acd811?w=800&h=600&fit=crop'),
  location: safeString(property.location, 'República Dominicana'),
  category: safeString(property.category, 'Propiedad'),
  bedrooms: safeNumber(property.bedrooms, 0),
  bathrooms: safeNumber(property.bathrooms, 0),
  area: safeNumber(property.area, 0),
  url: safeString(property.url, '#')
}));

const safeRelatedTestimonials = safeArray(data?.crossContent?.testimonials || data?.relatedTestimonials).map((testimonial, index) => ({
  id: safeString(testimonial.id, `testimonial-${index}`),
  title: safeString(testimonial.title, 'Testimonio'),
  excerpt: safeString(testimonial.excerpt, 'Historia de éxito'),
  clientName: safeString(testimonial.clientName, 'Cliente'),
  clientAvatar: safeString(testimonial.clientAvatar, '/images/default-avatar.jpg'),
  clientLocation: safeString(testimonial.clientLocation, 'República Dominicana'),
  rating: safeNumber(testimonial.rating, 5),
  url: safeString(testimonial.url, '#'),
  publishedAt: safeString(testimonial.publishedAt, new Date().toISOString())
}));

// Breadcrumbs
const safeSeo = safeObject(data?.seo);
const safeBreadcrumbs = safeArray(safeSeo.breadcrumbs, [
  {
    name: language === 'en' ? 'Home' : language === 'fr' ? 'Accueil' : 'Inicio',
    url: language === 'es' ? '/' : `/${language}/`
  },
  {
    name: language === 'en' ? 'Testimonials' : language === 'fr' ? 'Témoignages' : 'Testimonios',
    url: language === 'es' ? '/testimonios' : `/${language === 'en' ? 'en' : 'fr'}/testimonials`
  },
  {
    name: currentTestimonial.title,
    url: currentTestimonial.url
  }
]);

// Layout props
const layoutProps = {
  title: safeSeo.title || `${currentTestimonial.title} - ${currentTestimonial.clientName}`,
  description: safeSeo.description || currentTestimonial.excerpt,
  ogImage: safeSeo.ogImage || currentTestimonial.featuredImage || currentTestimonial.clientAvatar,
  canonical: safeSeo.canonical_url || currentTestimonial.url,
  language: language,
  globalConfig: data?.globalConfig || {},
  breadcrumbs: safeBreadcrumbs
};

// ===================================================================
// TEXTOS POR IDIOMA
// ===================================================================

const TEXTS = {
  es: {
    shareTestimonial: 'Compartir este testimonio',
    aboutAgent: 'Sobre el asesor',
    sendEmail: 'Enviar email',
    contactWhatsApp: 'Contactar por WhatsApp',
    callNow: 'Llamar ahora',
    relatedVideosTitle: 'Videos relacionados',
    relatedArticlesTitle: 'Artículos relacionados',
    relatedArticlesDesc: 'Lee más sobre experiencias similares',
    relatedTestimonialsTitle: 'Otros testimonios',
    relatedTestimonialsDesc: 'Conoce más historias de éxito',
    relatedPropertiesTitle: 'Propiedades destacadas',
    relatedPropertiesDesc: 'Descubre propiedades que te pueden interesar',
    minRead: 'min de lectura',
    views: 'vistas',
    facebook: 'Facebook',
    twitter: 'Twitter',
    linkedin: 'LinkedIn',
    publishedOn: 'Publicado el',
    watchNow: 'Ver ahora',
    viewProperty: 'Ver propiedad',
    readMore: 'Leer más',
    clientVerified: 'Cliente verificado',
    rating: 'Calificación'
  },
  en: {
    shareTestimonial: 'Share this testimonial',
    aboutAgent: 'About the agent',
    sendEmail: 'Send email',
    contactWhatsApp: 'Contact via WhatsApp',
    callNow: 'Call now',
    relatedVideosTitle: 'Related videos',
    relatedArticlesTitle: 'Related articles',
    relatedArticlesDesc: 'Read more about similar experiences',
    relatedTestimonialsTitle: 'Other testimonials',
    relatedTestimonialsDesc: 'Discover more success stories',
    relatedPropertiesTitle: 'Featured properties',
    relatedPropertiesDesc: 'Discover properties that might interest you',
    minRead: 'min read',
    views: 'views',
    facebook: 'Facebook',
    twitter: 'Twitter',
    linkedin: 'LinkedIn',
    publishedOn: 'Published on',
    watchNow: 'Watch now',
    viewProperty: 'View property',
    readMore: 'Read more',
    clientVerified: 'Verified client',
    rating: 'Rating'
  },
  fr: {
    shareTestimonial: 'Partager ce témoignage',
    aboutAgent: 'À propos du conseiller',
    sendEmail: 'Envoyer un email',
    contactWhatsApp: 'Contacter par WhatsApp',
    callNow: 'Appeler maintenant',
    relatedVideosTitle: 'Vidéos connexes',
    relatedArticlesTitle: 'Articles connexes',
    relatedArticlesDesc: 'Lisez-en plus sur des expériences similaires',
    relatedTestimonialsTitle: 'Autres témoignages',
    relatedTestimonialsDesc: 'Découvrez plus d\'histoires de réussite',
    relatedPropertiesTitle: 'Propriétés en vedette',
    relatedPropertiesDesc: 'Découvrez les propriétés qui pourraient vous intéresser',
    minRead: 'min de lecture',
    views: 'vues',
    facebook: 'Facebook',
    twitter: 'Twitter',
    linkedin: 'LinkedIn',
    publishedOn: 'Publié le',
    watchNow: 'Regarder',
    viewProperty: 'Voir la propriété',
    readMore: 'Lire la suite',
    clientVerified: 'Client vérifié',
    rating: 'Note'
  }
};

const text = TEXTS[language] || TEXTS.es;

// URLs según idioma
const routes = {
  es: { articlesBase: '/articulos', videosBase: '/videos', testimonialsBase: '/testimonios', propertiesBase: '/comprar' },
  en: { articlesBase: '/en/articles', videosBase: '/en/videos', testimonialsBase: '/en/testimonials', propertiesBase: '/en/buy' },
  fr: { articlesBase: '/fr/articles', videosBase: '/fr/videos', testimonialsBase: '/fr/temoignages', propertiesBase: '/fr/acheter' }
};

const currentRoutes = routes[language] || routes.es;

// Función para formatear fecha
function formatDate(dateString) {
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) {
      return language === 'en' ? 'Recent' : language === 'fr' ? 'Récent' : 'Reciente';
    }

    const months = {
      es: ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'],
      en: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
      fr: ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre']
    };

    const monthNames = months[language] || months.es;
    return `${date.getDate()} de ${monthNames[date.getMonth()]} de ${date.getFullYear()}`;
  } catch (error) {
    return language === 'en' ? 'Recent' : language === 'fr' ? 'Récent' : 'Reciente';
  }
}

console.log('✅ TestimonialsSingleLayout preparado:', {
  language,
  testimonialTitle: currentTestimonial.title,
  clientName: currentTestimonial.clientName,
  hasRelatedVideos: safeRelatedVideos.length > 0,
  hasRelatedArticles: safeRelatedArticles.length > 0,
  hasRelatedProperties: safeRelatedProperties.length > 0,
  hasRelatedTestimonials: safeRelatedTestimonials.length > 0
});
---

<Layout {...layoutProps}>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

  <div class="min-h-screen bg-white">

    <!-- Hero Section with Breadcrumbs -->
    <section class="relative bg-gradient-to-br from-gray-900 via-slate-800 to-gray-900 py-12 md:py-16 overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-b from-transparent via-black/20 to-black/40"></div>
      <div class="absolute top-0 left-0 w-72 h-72 bg-[#f04e00] rounded-full filter blur-[120px] opacity-10"></div>
      <div class="absolute bottom-0 right-0 w-72 h-72 bg-[#f04e00] rounded-full filter blur-[120px] opacity-10"></div>

      <div class="w-full px-4 relative z-10">
        <div class="max-w-5xl mx-auto">

          <!-- Breadcrumbs -->
          <nav class="text-sm mb-6 text-center" aria-label="Breadcrumb">
            {safeBreadcrumbs.map((breadcrumb, index) => (
              <span key={index}>
                {index > 0 && <span class="mx-2 text-gray-400">•</span>}
                {index === safeBreadcrumbs.length - 1 ? (
                  <span class="text-[#f04e00] font-medium">{breadcrumb.name}</span>
                ) : (
                  <a href={breadcrumb.url} class="text-gray-300 hover:text-white transition-colors">
                    {breadcrumb.name}
                  </a>
                )}
              </span>
            ))}
          </nav>

          <!-- Client Info Header -->
          <div class="flex flex-col items-center mb-4">
            <div class="relative mb-4">
              <img
                src={currentTestimonial.clientAvatar}
                alt={currentTestimonial.clientName}
                class="w-24 h-24 rounded-full border-4 border-white shadow-xl object-cover"
              />
              {currentTestimonial.clientVerified && (
                <div class="absolute bottom-0 right-0 bg-green-500 text-white p-2 rounded-full shadow-lg">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
              )}
            </div>

            <h2 class="text-xl font-bold text-white mb-1">{currentTestimonial.clientName}</h2>
            <p class="text-gray-300 text-sm mb-3">{currentTestimonial.clientLocation}</p>

            <!-- Rating -->
            <div class="flex items-center gap-2">
              <div class="flex">
                {Array.from({length: currentTestimonial.rating}, (_, i) => (
                  <svg key={i} class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                ))}
              </div>
              <span class="text-white font-semibold text-sm">{currentTestimonial.rating}/5</span>
            </div>
          </div>

          <!-- Title -->
          <div class="text-center">
            <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-3 leading-tight">
              {currentTestimonial.title}
            </h1>
            {currentTestimonial.excerpt && (
              <p class="text-lg md:text-xl text-gray-300 max-w-3xl mx-auto leading-relaxed font-light" set:html={currentTestimonial.excerpt}>
              </p>
            )}
          </div>

          <!-- Meta -->
          <div class="flex items-center justify-center gap-4 text-sm text-gray-300 mt-6">
            <span class="flex items-center gap-2">
              <i class="far fa-calendar text-gray-400"></i>
              {formatDate(currentTestimonial.publishedAt)}
            </span>
          </div>

        </div>
      </div>
    </section>

    <!-- Featured Image (if available) -->
    {currentTestimonial.featuredImage && (
      <section class="py-8 bg-gray-50">
        <div class="container mx-auto px-4">
          <div class="max-w-4xl mx-auto">
            <div class="aspect-video bg-gray-200 rounded-xl overflow-hidden shadow-lg">
              <img
                src={currentTestimonial.featuredImage}
                alt={currentTestimonial.title}
                class="w-full h-full object-cover"
                loading="lazy"
              />
            </div>
          </div>
        </div>
      </section>
    )}

    <!-- Full Testimonial Content -->
    <section class="py-16 md:py-20 bg-white">
      <div class="container mx-auto px-4">
        <div class="max-w-4xl mx-auto">

          {currentTestimonial.fullTestimonial && (
            <div class="prose prose-lg max-w-none mb-12">
              <div class="text-gray-700 leading-relaxed" set:html={currentTestimonial.fullTestimonial}>
              </div>
            </div>
          )}

          <!-- Share buttons -->
          <div class="mt-12 pt-8 border-t border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">{text.shareTestimonial}</h3>
            <div class="flex flex-wrap gap-3">
              <a
                href={`https://www.facebook.com/sharer/sharer.php?u=${currentTestimonial.url}`}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm"
              >
                <i class="fab fa-facebook"></i>
                {text.facebook}
              </a>

              <a
                href={`https://twitter.com/intent/tweet?url=${currentTestimonial.url}&text=${currentTestimonial.title}`}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 px-4 py-2 bg-blue-400 text-white rounded-lg hover:bg-blue-500 transition-colors text-sm"
              >
                <i class="fab fa-twitter"></i>
                {text.twitter}
              </a>

              <a
                href={`https://www.linkedin.com/sharing/share-offsite/?url=${currentTestimonial.url}`}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors text-sm"
              >
                <i class="fab fa-linkedin"></i>
                {text.linkedin}
              </a>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- Properties Section - Compact Grid -->
    {safeRelatedProperties.length > 0 && (
      <section class="py-16 bg-gradient-to-b from-white to-gray-50">
        <div class="container mx-auto px-4">
          <div class="max-w-7xl mx-auto">
            <div class="mb-10">
              <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
                {text.relatedPropertiesTitle}
              </h2>
              <p class="text-gray-600 text-sm">
                {text.relatedPropertiesDesc}
              </p>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              {safeRelatedProperties.slice(0, 8).map((property) => (
                <a href={property.url} class="group cursor-pointer" key={property.id}>
                  <div class="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden transition-all duration-200 hover:shadow-md hover:border-[#f04e00]/30 h-full flex flex-col">

                    <div class="relative aspect-[4/3] overflow-hidden bg-gray-200">
                      <img
                        src={property.image}
                        alt={property.name}
                        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                        loading="lazy"
                      />

                      {property.category && (
                        <div class="absolute top-2 left-2 bg-white/95 backdrop-blur-sm text-gray-900 px-2.5 py-1 rounded-md text-xs font-semibold shadow-sm">
                          {property.category}
                        </div>
                      )}

                      {property.price && (
                        <div class="absolute top-2 right-2 bg-[#f04e00] text-white px-3 py-1.5 rounded-md text-xs font-bold shadow-md">
                          {property.price}
                        </div>
                      )}
                    </div>

                    <div class="p-4 flex-1 flex flex-col">
                      <div class="flex items-center gap-1.5 text-gray-500 text-xs mb-2">
                        <i class="fas fa-map-marker-alt text-[#f04e00] text-xs"></i>
                        <span class="line-clamp-1">{property.location}</span>
                      </div>

                      <h3 class="font-semibold text-gray-900 group-hover:text-[#f04e00] transition-colors line-clamp-2 text-sm mb-3 leading-tight flex-1">
                        {property.name}
                      </h3>

                      <div class="flex items-center justify-start gap-4 pt-2 border-t border-gray-100">
                        {property.bedrooms > 0 && (
                          <div class="flex items-center gap-1 text-gray-600">
                            <i class="fas fa-bed text-[#f04e00] text-sm"></i>
                            <span class="text-xs font-medium">{property.bedrooms}</span>
                          </div>
                        )}
                        {property.bathrooms > 0 && (
                          <div class="flex items-center gap-1 text-gray-600">
                            <i class="fas fa-bath text-[#f04e00] text-sm"></i>
                            <span class="text-xs font-medium">{property.bathrooms}</span>
                          </div>
                        )}
                        {property.area > 0 && (
                          <div class="flex items-center gap-1 text-gray-600">
                            <i class="fas fa-ruler-combined text-[#f04e00] text-sm"></i>
                            <span class="text-xs font-medium">{property.area}m²</span>
                          </div>
                        )}
                      </div>
                    </div>

                  </div>
                </a>
              ))}
            </div>

            {safeRelatedProperties.length > 8 && (
              <div class="text-center mt-8">
                <a
                  href={currentRoutes.propertiesBase}
                  class="inline-flex items-center gap-2 text-[#f04e00] hover:text-[#d94400] font-semibold transition-colors text-sm"
                >
                  <span>{language === 'es' ? 'Ver todas las propiedades' : language === 'en' ? 'View all properties' : 'Voir toutes les propriétés'}</span>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"></path>
                  </svg>
                </a>
              </div>
            )}
          </div>
        </div>
      </section>
    )}

    <!-- Related Articles -->
    {safeRelatedArticles.length > 0 && (
      <section class="py-16 bg-gray-50">
        <div class="container mx-auto px-4">
          <div class="max-w-6xl mx-auto">
            <div class="mb-10">
              <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
                {text.relatedArticlesTitle}
              </h2>
              <p class="text-gray-600 text-sm">
                {text.relatedArticlesDesc}
              </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
              {safeRelatedArticles.slice(0, 6).map((article) => (
                <article class="bg-white rounded-lg shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden group" key={article.id}>
                  <a href={article.url} class="block">
                    <div class="aspect-[16/10] relative overflow-hidden">
                      <img
                        src={article.featuredImage}
                        alt={article.title}
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                        loading="lazy"
                      />
                      <div class="absolute top-3 right-3 bg-black/70 text-white px-3 py-1 rounded-full text-xs font-medium">
                        <i class="far fa-clock mr-1"></i>
                        {article.readTime}
                      </div>
                    </div>

                    <div class="p-6">
                      <h3 class="text-lg font-bold text-gray-900 mb-3 line-clamp-2 group-hover:text-[#f04e00] transition-colors leading-tight">
                        {article.title}
                      </h3>

                      <p class="text-gray-600 mb-4 line-clamp-3 text-sm leading-relaxed" set:html={article.excerpt}>
                      </p>

                      <div class="flex items-center justify-between text-sm text-gray-500">
                        <div class="flex items-center gap-2">
                          <img
                            src={article.author.avatar}
                            alt={article.author.name}
                            class="w-6 h-6 rounded-full"
                          />
                          <span class="truncate font-medium">{article.author.name}</span>
                        </div>
                        <span class="flex items-center gap-1">
                          <i class="far fa-eye"></i>
                          {article.views.toLocaleString()}
                        </span>
                      </div>
                    </div>
                  </a>
                </article>
              ))}
            </div>
          </div>
        </div>
      </section>
    )}

    <!-- Related Videos -->
    {safeRelatedVideos.length > 0 && (
      <section class="py-16 bg-white">
        <div class="container mx-auto px-4">
          <div class="max-w-6xl mx-auto">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-8">
              {text.relatedVideosTitle}
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              {safeRelatedVideos.slice(0, 4).map((video) => (
                <a href={video.url} class="group block" key={video.id}>
                  <div class="aspect-video relative overflow-hidden rounded-lg bg-gray-200 mb-4">
                    <img
                      src={video.thumbnail}
                      alt={video.title}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                      loading="lazy"
                    />
                    <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                      <div class="w-16 h-16 bg-white/90 rounded-full flex items-center justify-center">
                        <i class="fas fa-play text-[#f04e00] text-xl ml-1"></i>
                      </div>
                    </div>
                    <div class="absolute bottom-2 right-2 bg-black/80 text-white px-2 py-1 rounded text-xs font-medium">
                      {video.duration}
                    </div>
                  </div>
                  <h3 class="font-semibold text-gray-900 group-hover:text-[#f04e00] transition-colors line-clamp-2 text-sm">
                    {video.title}
                  </h3>
                  <p class="text-gray-500 text-xs mt-2">
                    {video.author.name}
                  </p>
                </a>
              ))}
            </div>
          </div>
        </div>
      </section>
    )}

    <!-- Other Testimonials -->
    {safeRelatedTestimonials.length > 0 && (
      <section class="py-16 bg-gray-50">
        <div class="container mx-auto px-4">
          <div class="max-w-6xl mx-auto">
            <div class="mb-10">
              <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
                {text.relatedTestimonialsTitle}
              </h2>
              <p class="text-gray-600 text-sm">
                {text.relatedTestimonialsDesc}
              </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {safeRelatedTestimonials.slice(0, 6).map((testimonial) => (
                <a href={testimonial.url} class="group block" key={testimonial.id}>
                  <div class="bg-white rounded-lg shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden p-6">
                    <div class="flex items-start gap-4 mb-4">
                      <img
                        src={testimonial.clientAvatar}
                        alt={testimonial.clientName}
                        class="w-12 h-12 rounded-full object-cover border-2 border-gray-200"
                      />
                      <div class="flex-1">
                        <h3 class="font-semibold text-gray-900 group-hover:text-[#f04e00] transition-colors">
                          {testimonial.clientName}
                        </h3>
                        <p class="text-sm text-gray-500">{testimonial.clientLocation}</p>
                        <div class="flex mt-1">
                          {Array.from({length: testimonial.rating}, (_, i) => (
                            <svg key={i} class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                          ))}
                        </div>
                      </div>
                    </div>
                    <h4 class="font-medium text-gray-900 mb-2 line-clamp-2">
                      {testimonial.title}
                    </h4>
                    <p class="text-gray-600 text-sm line-clamp-3" set:html={testimonial.excerpt}>
                    </p>
                  </div>
                </a>
              ))}
            </div>
          </div>
        </div>
      </section>
    )}

    <!-- Agent Bio - Enhanced -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
          <div class="p-8 bg-gradient-to-r from-gray-900/5 to-gray-900/10 rounded-xl border border-gray-200">
            <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-6">{text.aboutAgent}</h3>
            <div class="flex items-start gap-6">
              <div class="flex-shrink-0">
                <img
                  src={currentTestimonial.agent.avatar}
                  alt={currentTestimonial.agent.name}
                  class="w-20 h-20 rounded-full border-4 border-white shadow-lg object-cover"
                />
              </div>
              <div class="flex-1">
                <h4 class="text-xl font-bold text-gray-900 mb-1">{currentTestimonial.agent.name}</h4>
                <p class="text-[#f04e00] font-semibold mb-3 text-sm">{currentTestimonial.agent.position}</p>

                <div class="flex flex-wrap gap-3 pt-2">
                  <a
                    href={`https://wa.me/18094872542?text=${encodeURIComponent(`Hola, vi el testimonio de ${currentTestimonial.clientName} y me gustaría más información`)}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all duration-200 text-xs font-medium shadow-sm hover:shadow-md"
                  >
                    <i class="fab fa-whatsapp"></i>
                    {text.contactWhatsApp}
                  </a>

                  <a
                    href="mailto:info@clicinmobiliaria.com"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-[#f04e00] text-white rounded-lg hover:bg-[#d94400] transition-all duration-200 text-xs font-medium shadow-sm hover:shadow-md"
                  >
                    <i class="far fa-envelope"></i>
                    {text.sendEmail}
                  </a>

                  <a
                    href="tel:+18094872542"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-all duration-200 text-xs font-medium shadow-sm hover:shadow-md border border-gray-700"
                  >
                    <i class="fas fa-phone"></i>
                    {text.callNow}
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>
</Layout>

<style>
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .aspect-video {
    aspect-ratio: 16 / 9;
  }

  .group:hover .group-hover\:scale-105 {
    transform: scale(1.05);
  }

  .group:hover .group-hover\:text-[#f04e00] {
    color: #f04e00;
  }
</style>
