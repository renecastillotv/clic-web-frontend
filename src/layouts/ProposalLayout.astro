---
// src/layouts/ProposalLayout.astro - Layout para propuestas del CRM
import Layout from './Layout.astro';

// ===================================================================
// EXTRACCI√ìN DE DATOS DEL PROP
// ===================================================================

const { data } = Astro.props;
const language = data?.language || 'es';
const globalConfig = data?.globalConfig || null;
const proposalToken = data?.proposalToken || '';

// Generar hreflangData para propuestas basado en el token
// Las propuestas usan la misma URL base con diferentes prefijos de idioma
const baseUrl = Astro.url.origin;
const hreflangData = proposalToken ? {
  es: `${baseUrl}/propuestas/${proposalToken}`,
  en: `${baseUrl}/en/proposals/${proposalToken}`,
  fr: `${baseUrl}/fr/propositions/${proposalToken}`
} : (data?.seo?.hreflang || {});

// ===================================================================
// TEXTOS POR IDIOMA
// ===================================================================

const TEXTS = {
  es: {
    title: 'Propuesta de Propiedades - CLIC Inmobiliaria',
    description: 'Tu selecci√≥n personalizada de propiedades preparada por tu asesor.',
    pageTitle: 'Propuesta de Propiedades',
    greeting: 'Hola',
    hasPrepared: 'ha preparado esta propuesta especialmente para ti',
    loading: 'Cargando propuesta...',
    notFound: 'Propuesta no encontrada',
    notFoundDescription: 'Esta propuesta no existe o ha expirado',
    expired: 'Propuesta expirada',
    expiredDescription: 'Esta propuesta ha expirado. Contacta a tu asesor para una nueva.',
    exploreButton: 'Explorar propiedades',
    contactAdvisor: 'Contactar asesor',
    propertiesCount: 'propiedades seleccionadas',
    yourAdvisor: 'Tu asesor',
    viewProfile: 'Ver perfil',
    likeIt: 'Me gusta',
    dontLikeIt: 'No me gusta',
    maybe: 'Tal vez',
    addComment: 'Comentar',
    commentPlaceholder: 'Escribe tu opini√≥n sobre esta propiedad...',
    saveComment: 'Enviar',
    cancel: 'Cancelar',
    viewDetails: 'Ver detalles',
    specialPrice: 'Precio especial',
    advisorNotes: 'Nota del asesor',
    yourReactions: 'Tus opiniones',
    thankYou: '¬°Gracias por tu opini√≥n!',
    helpText: 'Marca las propiedades que te gustan para que tu asesor pueda ayudarte mejor',
    messageFromAdvisor: 'Mensaje de tu asesor',
    aboutSelection: 'Acerca de esta selecci√≥n',
    routes: {
      properties: '/comprar',
      advisors: '/asesores'
    }
  },
  en: {
    title: 'Property Proposal - CLIC Real Estate',
    description: 'Your personalized property selection prepared by your advisor.',
    pageTitle: 'Property Proposal',
    greeting: 'Hello',
    hasPrepared: 'has prepared this proposal especially for you',
    loading: 'Loading proposal...',
    notFound: 'Proposal not found',
    notFoundDescription: 'This proposal does not exist or has expired',
    expired: 'Proposal expired',
    expiredDescription: 'This proposal has expired. Contact your advisor for a new one.',
    exploreButton: 'Explore properties',
    contactAdvisor: 'Contact advisor',
    propertiesCount: 'selected properties',
    yourAdvisor: 'Your advisor',
    viewProfile: 'View profile',
    likeIt: 'I like it',
    dontLikeIt: "Don't like it",
    maybe: 'Maybe',
    addComment: 'Comment',
    commentPlaceholder: 'Write your opinion about this property...',
    saveComment: 'Send',
    cancel: 'Cancel',
    viewDetails: 'View details',
    specialPrice: 'Special price',
    advisorNotes: 'Advisor notes',
    yourReactions: 'Your opinions',
    thankYou: 'Thank you for your feedback!',
    helpText: 'Mark the properties you like so your advisor can help you better',
    messageFromAdvisor: 'Message from your advisor',
    aboutSelection: 'About this selection',
    routes: {
      properties: '/en/buy',
      advisors: '/en/advisors'
    }
  },
  fr: {
    title: 'Proposition Immobili√®re - CLIC Immobilier',
    description: 'Votre s√©lection personnalis√©e pr√©par√©e par votre conseiller.',
    pageTitle: 'Proposition Immobili√®re',
    greeting: 'Bonjour',
    hasPrepared: 'a pr√©par√© cette proposition sp√©cialement pour vous',
    loading: 'Chargement de la proposition...',
    notFound: 'Proposition non trouv√©e',
    notFoundDescription: "Cette proposition n'existe pas ou a expir√©",
    expired: 'Proposition expir√©e',
    expiredDescription: 'Cette proposition a expir√©. Contactez votre conseiller pour une nouvelle.',
    exploreButton: 'Explorer les propri√©t√©s',
    contactAdvisor: 'Contacter le conseiller',
    propertiesCount: 'propri√©t√©s s√©lectionn√©es',
    yourAdvisor: 'Votre conseiller',
    viewProfile: 'Voir le profil',
    likeIt: "J'aime",
    dontLikeIt: "Je n'aime pas",
    maybe: 'Peut-√™tre',
    addComment: 'Commenter',
    commentPlaceholder: '√âcrivez votre avis sur cette propri√©t√©...',
    saveComment: 'Envoyer',
    cancel: 'Annuler',
    viewDetails: 'Voir les d√©tails',
    specialPrice: 'Prix sp√©cial',
    advisorNotes: 'Notes du conseiller',
    yourReactions: 'Vos opinions',
    thankYou: 'Merci pour votre avis!',
    helpText: 'Marquez les propri√©t√©s que vous aimez pour que votre conseiller puisse mieux vous aider',
    messageFromAdvisor: 'Message de votre conseiller',
    aboutSelection: '√Ä propos de cette s√©lection',
    routes: {
      properties: '/fr/acheter',
      advisors: '/fr/conseillers'
    }
  }
};

const text = TEXTS[language] || TEXTS.es;

console.log('‚úÖ ProposalLayout preparado:', {
  language,
  proposalToken,
  originalUrl: data?.originalUrl,
  hreflangData: hreflangData
});
---

<Layout
  title={text.title}
  description={text.description}
  language={language}
  globalConfig={globalConfig}
  hreflangData={hreflangData}
>
  <!-- Loading State -->
  <div id="loadingState" class="text-center py-16 bg-gray-50">
    <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-2 border-[#f04e00]"></div>
    <p class="mt-6 text-gray-600 text-lg">{text.loading}</p>
  </div>

  <!-- Error State -->
  <div id="errorState" class="text-center py-16 hidden bg-gray-50">
    <div class="text-8xl mb-6">üòû</div>
    <h2 id="errorTitle" class="text-3xl font-bold text-gray-900 mb-4">{text.notFound}</h2>
    <p id="errorDescription" class="text-xl text-gray-600 mb-10 max-w-2xl mx-auto">
      {text.notFoundDescription}
    </p>
    <a
      href={text.routes.properties}
      class="inline-flex items-center gap-2 px-6 py-3 bg-[#f04e00] text-white rounded-lg hover:bg-[#e03d00] transition-all font-semibold shadow-lg hover:shadow-xl ref-link"
    >
      {text.exploreButton}
      <i class="fas fa-arrow-right"></i>
    </a>
  </div>

  <!-- Proposal Content -->
  <div id="proposalContent" class="hidden">

    <!-- Hero Header - Full Width -->
    <section class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white relative overflow-hidden">
      <div class="absolute inset-0 opacity-10">
        <div class="absolute top-0 left-0 w-96 h-96 bg-[#f04e00] rounded-full filter blur-3xl"></div>
        <div class="absolute bottom-0 right-0 w-96 h-96 bg-blue-600 rounded-full filter blur-3xl"></div>
      </div>

      <div class="container mx-auto px-4">
        <div class="relative z-10 py-8 md:py-12">
          <!-- Layout horizontal: Avatar | Info | Contact -->
          <div class="flex flex-col lg:flex-row items-center gap-6 lg:gap-8">

            <!-- Avatar + Badge (Left) -->
            <div id="advisorCard" class="relative flex-shrink-0 hidden">
              <div class="w-28 h-28 lg:w-36 lg:h-36 rounded-2xl overflow-hidden ring-4 ring-[#f04e00]/30 shadow-2xl">
                <img
                  id="advisorPhoto"
                  src="/images/team/default-advisor.jpg"
                  alt="Asesor"
                  class="w-full h-full object-cover"
                />
              </div>
              <div id="advisorPhotoPlaceholder" class="hidden w-28 h-28 lg:w-36 lg:h-36 rounded-2xl bg-[#f04e00] flex items-center justify-center text-5xl font-bold ring-4 ring-[#f04e00]/30">
                A
              </div>
              <div class="absolute -bottom-2 -right-2 bg-gradient-to-r from-[#f04e00] to-[#ff6b35] text-white px-3 py-1 rounded-full text-xs font-bold shadow-xl">
                <i class="fas fa-user-tie mr-1"></i>
                {text.yourAdvisor}
              </div>
            </div>

            <!-- Info Principal (Center) -->
            <div class="flex-1 text-center lg:text-left space-y-3">
              <!-- Greeting with Client Name -->
              <h1 id="greetingSection" class="text-2xl lg:text-3xl font-bold">
                <span id="greetingText">{text.greeting}</span><span id="clientNameSection">, <span id="clientName" class="text-[#f04e00]"></span></span>
              </h1>

              <!-- Advisor Introduction -->
              <p class="text-lg text-white/80">
                <span id="advisorNameIntro" class="font-semibold text-white"></span> {text.hasPrepared}
              </p>

              <!-- Properties Count Badge -->
              <div class="flex flex-wrap gap-2 justify-center lg:justify-start mt-4">
                <span class="inline-flex items-center gap-1.5 bg-[#f04e00]/20 px-3 py-1.5 rounded-lg text-sm font-semibold">
                  <span id="propertiesCount" class="text-[#f04e00]">0</span>
                  <span class="text-white/90">{text.propertiesCount}</span>
                </span>
              </div>
            </div>

            <!-- Contact Buttons (Right) -->
            <div id="advisorContactButtons" class="hidden flex flex-col gap-2 flex-shrink-0">
              <a
                id="advisorWhatsapp"
                href="#"
                target="_blank"
                class="hidden inline-flex items-center justify-center gap-2 px-6 py-2.5 bg-[#25D366] text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm whitespace-nowrap"
              >
                <i class="fab fa-whatsapp"></i>
                WhatsApp
              </a>

              <a
                id="advisorPhone"
                href="#"
                class="hidden inline-flex items-center justify-center gap-2 px-6 py-2.5 bg-gradient-to-r from-[#f04e00] to-[#ff6b35] text-white rounded-lg hover:shadow-lg transition-all font-semibold text-sm whitespace-nowrap"
              >
                <i class="fas fa-phone"></i>
                <span class="hidden lg:inline">{text.contactAdvisor}</span>
              </a>

              <a
                id="advisorEmail"
                href="#"
                class="hidden inline-flex items-center justify-center gap-2 px-6 py-2.5 bg-white/10 border border-white/20 text-white rounded-lg hover:bg-white/20 transition-all font-semibold text-sm whitespace-nowrap"
              >
                <i class="fas fa-envelope"></i>
                Email
              </a>

              <a
                id="advisorProfileLink"
                href="#"
                class="hidden inline-flex items-center justify-center gap-2 px-6 py-2.5 border border-white/30 text-white rounded-lg hover:bg-white/10 transition-all font-medium text-sm whitespace-nowrap ref-link"
              >
                <i class="fas fa-user"></i>
                {text.viewProfile}
              </a>
            </div>
          </div>

          <!-- Proposal Description -->
          <div id="proposalDescriptionBox" class="hidden mt-6 p-4 bg-white/10 backdrop-blur-sm rounded-xl border border-white/20">
            <p class="text-xs text-white/60 mb-1 font-medium uppercase tracking-wider">{text.messageFromAdvisor}</p>
            <p id="proposalDescription" class="text-white/90"></p>
          </div>
        </div>
      </div>
    </section>

    <!-- Properties Section -->
    <section class="py-8 bg-gray-50 min-h-screen">
      <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">

          <!-- Preview Mode Banner (only visible in preview) -->
          <div id="previewBanner" class="hidden mb-8 p-4 bg-amber-50 rounded-xl border border-amber-200">
            <p class="text-amber-700 text-sm flex items-center gap-2 font-medium">
              <i class="fas fa-eye"></i>
              <span>Modo Vista Previa - Las vistas no se contabilizan y las reacciones est√°n deshabilitadas</span>
            </p>
          </div>

          <!-- Help text (hidden in preview) -->
          <div id="helpTextBox" class="mb-8 p-4 bg-blue-50 rounded-xl border border-blue-100">
            <p class="text-blue-700 text-sm flex items-center gap-2">
              <i class="fas fa-info-circle"></i>
              {text.helpText}
            </p>
          </div>

          <!-- Properties Grid -->
          <div id="propertiesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Properties will be loaded here -->
          </div>

        </div>
      </div>
    </section>
  </div>

  <!-- Comment Modal -->
  <div id="commentModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50" onclick="if(event.target === this) closeCommentModal()">
    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-900">{text.addComment}</h3>
        <button onclick="closeCommentModal()" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
          <i class="fas fa-times text-gray-500"></i>
        </button>
      </div>

      <form onsubmit="saveComment(event)">
        <input type="hidden" id="commentPropertyId" value="" />
        <textarea
          id="commentText"
          class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#f04e00] focus:border-[#f04e00] transition-all resize-none"
          rows="4"
          placeholder={text.commentPlaceholder}
          required
        ></textarea>

        <div class="flex justify-end gap-3 mt-4">
          <button
            type="button"
            onclick="closeCommentModal()"
            class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-medium"
          >
            {text.cancel}
          </button>
          <button
            type="submit"
            class="px-5 py-2.5 bg-[#f04e00] text-white rounded-lg hover:bg-[#e03d00] transition-all font-semibold"
          >
            <i class="fas fa-paper-plane mr-2"></i>
            {text.saveComment}
          </button>
        </div>
      </form>
    </div>
  </div>

  <script define:vars={{ proposalToken, language, textData: text }}>
    // ===================================================================
    // ESTADO GLOBAL
    // ===================================================================
    // Detectar modo preview desde URL
    const urlParams = new URLSearchParams(window.location.search);
    const isPreviewMode = urlParams.get('preview') === 'true';

    const pageState = {
      proposalToken: proposalToken,
      proposal: null,
      properties: [],
      reactions: {},
      advisor: null,
      language: language,
      text: textData,
      isPreview: isPreviewMode
    };

    const API_URL = 'https://clic-api-neon.vercel.app/api/proposals';

    // ===================================================================
    // INICIALIZACI√ìN
    // ===================================================================
    async function initializePage() {
      console.log('üöÄ Initializing proposal page with token:', pageState.proposalToken, pageState.isPreview ? '(PREVIEW MODE)' : '');

      if (!pageState.proposalToken) {
        showError();
        return;
      }

      try {
        // Pasar preview=true a la API si estamos en modo preview
        const apiUrl = pageState.isPreview
          ? `${API_URL}/${pageState.proposalToken}?preview=true`
          : `${API_URL}/${pageState.proposalToken}`;
        const response = await fetch(apiUrl);
        const result = await response.json();

        console.log('üì¶ API Response:', result);

        if (!response.ok) {
          if (response.status === 410) {
            // Expired
            showError(pageState.text.expired, pageState.text.expiredDescription);
          } else {
            showError();
          }
          return;
        }

        if (result.success && result.data) {
          pageState.proposal = result.data;
          pageState.properties = result.data.properties || [];
          pageState.reactions = result.data.reactions || {};
          pageState.advisor = result.data.advisor;

          updateUI();
          showContent();
        } else {
          showError();
        }

      } catch (error) {
        console.error('‚ùå Error loading proposal:', error);
        showError();
      }
    }

    // ===================================================================
    // UI FUNCTIONS
    // ===================================================================
    function showLoading() {
      document.getElementById('loadingState').classList.remove('hidden');
      document.getElementById('errorState').classList.add('hidden');
      document.getElementById('proposalContent').classList.add('hidden');
    }

    function showError(title, description) {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');
      document.getElementById('proposalContent').classList.add('hidden');

      if (title) {
        document.getElementById('errorTitle').textContent = title;
      }
      if (description) {
        document.getElementById('errorDescription').textContent = description;
      }
    }

    function showContent() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorState').classList.add('hidden');
      document.getElementById('proposalContent').classList.remove('hidden');

      // Handle preview mode UI
      if (pageState.isPreview) {
        document.getElementById('previewBanner').classList.remove('hidden');
        document.getElementById('helpTextBox').classList.add('hidden');
      }
    }

    function updateUI() {
      const proposal = pageState.proposal;
      const advisor = pageState.advisor;
      const contact = proposal.contact;

      // Store advisor code for ref links
      if (advisor?.codigo) {
        pageState.advisorCode = advisor.codigo;
      }

      // Update client name
      const clientNameEl = document.getElementById('clientName');
      const clientNameSection = document.getElementById('clientNameSection');
      if (contact?.nombre_completo || contact?.nombre) {
        const clientName = contact.nombre_completo || contact.nombre;
        clientNameEl.textContent = clientName;
      } else {
        // If no contact, hide the ", [name]" part completely
        clientNameSection.classList.add('hidden');
      }

      // Update advisor intro
      const advisorIntroEl = document.getElementById('advisorNameIntro');
      if (advisor?.nombre_completo || advisor?.nombre) {
        const advisorName = advisor.nombre_completo || advisor.nombre;
        advisorIntroEl.textContent = advisorName;
      } else {
        // Hide advisor intro if no advisor
        advisorIntroEl.parentElement.classList.add('hidden');
      }

      // Update proposal description box (shows title + description if available)
      const descBox = document.getElementById('proposalDescriptionBox');
      const descEl = document.getElementById('proposalDescription');

      if (proposal.titulo || proposal.descripcion) {
        descBox.classList.remove('hidden');
        // Combine title and description
        let descText = '';
        if (proposal.titulo) descText = proposal.titulo;
        if (proposal.titulo && proposal.descripcion) descText += ': ';
        if (proposal.descripcion) descText += proposal.descripcion;
        descEl.textContent = descText;
      }

      // Update properties count
      document.getElementById('propertiesCount').textContent = pageState.properties.length;

      // Update advisor card and contact buttons
      if (advisor) {
        const advisorCard = document.getElementById('advisorCard');
        const contactButtons = document.getElementById('advisorContactButtons');

        advisorCard.classList.remove('hidden');
        contactButtons.classList.remove('hidden');
        contactButtons.classList.add('flex');

        const advisorName = advisor.nombre_completo || advisor.nombre || 'Asesor';

        // Photo
        const photoEl = document.getElementById('advisorPhoto');
        const placeholderEl = document.getElementById('advisorPhotoPlaceholder');

        if (advisor.foto) {
          photoEl.src = advisor.foto;
          photoEl.alt = advisorName;
          photoEl.parentElement.classList.remove('hidden');
          placeholderEl.classList.add('hidden');
        } else {
          // Show initial placeholder
          photoEl.parentElement.classList.add('hidden');
          placeholderEl.classList.remove('hidden');
          placeholderEl.classList.add('flex');
          placeholderEl.textContent = advisorName.charAt(0).toUpperCase();
        }

        // Phone
        if (advisor.telefono) {
          const phoneEl = document.getElementById('advisorPhone');
          phoneEl.href = `tel:${advisor.telefono}`;
          phoneEl.classList.remove('hidden');
          phoneEl.classList.add('inline-flex');
        }

        // WhatsApp
        if (advisor.whatsapp || advisor.telefono) {
          const phone = advisor.whatsapp || advisor.telefono;
          const cleanPhone = phone.replace(/\D/g, '');
          const whatsappEl = document.getElementById('advisorWhatsapp');
          whatsappEl.href = `https://wa.me/${cleanPhone}`;
          whatsappEl.classList.remove('hidden');
          whatsappEl.classList.add('inline-flex');
        }

        // Email
        if (advisor.email) {
          const emailEl = document.getElementById('advisorEmail');
          emailEl.href = `mailto:${advisor.email}`;
          emailEl.classList.remove('hidden');
          emailEl.classList.add('inline-flex');
        }

        // Profile link
        if (advisor.slug) {
          const profileEl = document.getElementById('advisorProfileLink');
          profileEl.href = `${pageState.text.routes.advisors}/${advisor.slug}`;
          profileEl.classList.remove('hidden');
          profileEl.classList.add('inline-flex');
        }
      }

      // Apply ref parameter to all links
      applyRefToLinks();

      // Render properties
      renderProperties();
    }

    // ===================================================================
    // TRACKING PARAMETERS
    // ===================================================================
    // List of tracking parameters to preserve across all links
    const TRACKING_PARAMS = ['ref', 'utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'fbclid', 'gclid', 'msclkid'];

    // Get all tracking params from current URL
    function getTrackingParams() {
      const params = new URLSearchParams();

      // Add advisor code as ref if available
      if (pageState.advisorCode) {
        params.set('ref', pageState.advisorCode);
      }

      // Preserve any tracking params from current URL
      const currentParams = new URLSearchParams(window.location.search);
      TRACKING_PARAMS.forEach(param => {
        const value = currentParams.get(param);
        if (value && param !== 'ref') { // ref is handled by advisorCode
          params.set(param, value);
        }
      });

      return params;
    }

    // Apply tracking parameters to ALL links on the page
    function applyTrackingToLinks() {
      const trackingParams = getTrackingParams();
      const trackingString = trackingParams.toString();

      if (!trackingString) return;

      // Find ALL links on the page (header, footer, property cards, etc.)
      document.querySelectorAll('a').forEach(link => {
        const href = link.getAttribute('href');

        // Skip empty, anchor-only, external protocols, and already processed links
        if (!href ||
            href === '#' ||
            href.startsWith('mailto:') ||
            href.startsWith('tel:') ||
            href.startsWith('javascript:') ||
            link.dataset.trackingApplied) {
          return;
        }

        try {
          // Parse the URL to handle existing params properly
          const url = new URL(href, window.location.origin);

          // Only apply to same-origin links or relative links
          if (url.origin === window.location.origin || href.startsWith('/')) {
            // Add tracking params, avoiding duplicates
            trackingParams.forEach((value, key) => {
              if (!url.searchParams.has(key)) {
                url.searchParams.set(key, value);
              }
            });

            link.setAttribute('href', url.pathname + url.search + url.hash);
            link.dataset.trackingApplied = 'true';
          }
        } catch (e) {
          // For invalid URLs, fallback to simple string concat
          const separator = href.includes('?') ? '&' : '?';
          link.setAttribute('href', `${href}${separator}${trackingString}`);
          link.dataset.trackingApplied = 'true';
        }
      });
    }

    // Get URL with tracking parameters (for dynamic content)
    function getTrackedUrl(url) {
      if (!url) return '#';

      const trackingParams = getTrackingParams();
      const trackingString = trackingParams.toString();

      if (!trackingString) return url;

      try {
        const parsedUrl = new URL(url, window.location.origin);
        trackingParams.forEach((value, key) => {
          if (!parsedUrl.searchParams.has(key)) {
            parsedUrl.searchParams.set(key, value);
          }
        });
        return parsedUrl.pathname + parsedUrl.search + parsedUrl.hash;
      } catch (e) {
        const separator = url.includes('?') ? '&' : '?';
        return `${url}${separator}${trackingString}`;
      }
    }

    // Alias for backwards compatibility
    function applyRefToLinks() {
      applyTrackingToLinks();
    }

    function getRefUrl(url) {
      return getTrackedUrl(url);
    }

    function renderProperties() {
      const grid = document.getElementById('propertiesGrid');
      if (!grid) return;

      if (pageState.properties.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12 text-gray-500">
            <div class="text-6xl mb-4">üì¶</div>
            <p>No hay propiedades en esta propuesta</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = pageState.properties.map((property, index) => {
        const reactions = pageState.reactions[property.id] || { like: false, dislike: false, maybe: false, comments: [] };

        // Get all images
        const allImages = [];
        if (property.imagen) allImages.push(property.imagen);
        if (property.imagenes && Array.isArray(property.imagenes)) {
          property.imagenes.forEach(img => {
            if (img && !allImages.includes(img)) allImages.push(img);
          });
        }
        if (allImages.length === 0) {
          allImages.push('https://via.placeholder.com/400x300/e5e7eb/9ca3af?text=Sin+Imagen');
        }

        return `
          <div class="property-card bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden hover:shadow-xl transition-all duration-300" data-property-id="${property.id}">
            <!-- Image Carousel -->
            <div class="relative aspect-[4/3] overflow-hidden bg-gradient-to-br from-gray-100 to-gray-200 group">
              <div class="carousel-container relative w-full h-full" data-carousel="${index}">
                ${allImages.map((img, imgIndex) => `
                  <img
                    src="${img}"
                    alt="${property.titulo || property.name} - Imagen ${imgIndex + 1}"
                    class="carousel-slide absolute inset-0 w-full h-full object-cover transition-opacity duration-300 ${imgIndex === 0 ? 'opacity-100' : 'opacity-0'}"
                    data-index="${imgIndex}"
                    loading="lazy"
                    onerror="this.src='https://via.placeholder.com/400x300/e5e7eb/9ca3af?text=Sin+Imagen';"
                  />
                `).join('')}

                ${allImages.length > 1 ? `
                  <button
                    onclick="event.stopPropagation(); changeSlide(${index}, -1)"
                    class="absolute left-2 top-1/2 -translate-y-1/2 p-2 bg-black/50 hover:bg-black/70 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10"
                  >
                    <i class="fas fa-chevron-left text-sm"></i>
                  </button>
                  <button
                    onclick="event.stopPropagation(); changeSlide(${index}, 1)"
                    class="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-black/50 hover:bg-black/70 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10"
                  >
                    <i class="fas fa-chevron-right text-sm"></i>
                  </button>

                  <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1.5 z-10">
                    ${allImages.map((_, dotIndex) => `
                      <button
                        onclick="event.stopPropagation(); goToSlide(${index}, ${dotIndex})"
                        class="carousel-dot w-2 h-2 rounded-full transition-all ${dotIndex === 0 ? 'bg-white w-4' : 'bg-white/50 hover:bg-white/80'}"
                        data-carousel="${index}"
                        data-dot="${dotIndex}"
                      ></button>
                    `).join('')}
                  </div>

                  <div class="absolute top-3 right-3 bg-black/60 text-white px-2 py-1 rounded text-xs font-medium z-10">
                    <i class="fas fa-camera mr-1"></i>
                    <span class="carousel-counter" data-carousel="${index}">1</span>/${allImages.length}
                  </div>
                ` : ''}
              </div>

              ${property.tipo ? `
                <span class="absolute top-3 left-3 bg-[#f04e00] text-white px-3 py-1.5 rounded-lg text-xs font-semibold shadow-lg z-10">
                  ${property.tipo}
                </span>
              ` : ''}

              ${property.tiene_precio_especial ? `
                <span class="absolute top-3 left-3 ${property.tipo ? 'ml-20' : ''} bg-green-500 text-white px-3 py-1.5 rounded-lg text-xs font-semibold shadow-lg z-10">
                  <i class="fas fa-tag mr-1"></i> ${pageState.text.specialPrice}
                </span>
              ` : ''}
            </div>

            <!-- Content -->
            <div class="p-5">
              <!-- Price -->
              <div class="mb-3">
                <p class="text-xl font-bold text-[#f04e00]">${property.precio}</p>
              </div>

              <!-- Code and link -->
              <div class="flex items-center justify-between mb-2">
                ${property.code ? `
                  <div class="text-xs text-gray-400 font-mono">ref.: ${property.code}</div>
                ` : '<div></div>'}
                <a
                  href="${getRefUrl(property.url)}"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-xs text-[#f04e00] hover:text-[#e03d00] font-medium flex items-center gap-1"
                >
                  <i class="fas fa-external-link-alt"></i>
                  ${pageState.text.viewDetails}
                </a>
              </div>

              <!-- Location -->
              <div class="flex items-center gap-1 mb-2">
                <i class="fas fa-map-marker-alt text-gray-400 text-sm"></i>
                <p class="text-sm text-gray-600 truncate">${property.sector || 'Ubicaci√≥n no especificada'}</p>
              </div>

              <!-- Title -->
              <h3 class="font-bold text-lg text-gray-900 line-clamp-2 leading-tight mb-4">
                ${property.titulo || property.name || 'Propiedad sin nombre'}
              </h3>

              <!-- Features -->
              <div class="flex items-center justify-center gap-4 mb-4 pb-4 border-b border-gray-100">
                ${property.habitaciones > 0 ? `
                  <span class="flex items-center gap-1.5">
                    <i class="fas fa-bed text-[#f04e00] text-sm"></i>
                    <span class="font-semibold text-sm text-gray-700">${property.habitaciones}</span>
                  </span>
                ` : ''}
                ${property.banos > 0 ? `
                  <span class="flex items-center gap-1.5">
                    <i class="fas fa-bath text-[#f04e00] text-sm"></i>
                    <span class="font-semibold text-sm text-gray-700">${property.banos}</span>
                  </span>
                ` : ''}
                ${property.metros > 0 ? `
                  <span class="flex items-center gap-1.5">
                    <i class="fas fa-th-large text-[#f04e00] text-sm"></i>
                    <span class="font-semibold text-sm text-gray-700">${property.metros} m¬≤</span>
                  </span>
                ` : ''}
                ${property.estacionamientos > 0 ? `
                  <span class="flex items-center gap-1.5">
                    <i class="fas fa-car text-[#f04e00] text-sm"></i>
                    <span class="font-semibold text-sm text-gray-700">${property.estacionamientos}</span>
                  </span>
                ` : ''}
              </div>

              ${property.notas_propuesta ? `
                <div class="mb-4 p-3 bg-amber-50 rounded-lg border border-amber-100">
                  <p class="text-xs text-amber-600 font-medium mb-1">
                    <i class="fas fa-sticky-note mr-1"></i> ${pageState.text.advisorNotes}
                  </p>
                  <p class="text-sm text-amber-800">${property.notas_propuesta}</p>
                </div>
              ` : ''}

              <!-- Reactions (hidden in preview mode) -->
              ${!pageState.isPreview ? `
              <div class="pt-4">
                <div class="grid grid-cols-3 gap-2 mb-3">
                  <button
                    onclick="toggleReaction('${property.id}', 'like')"
                    class="reaction-btn flex items-center justify-center gap-1 py-2 rounded-lg font-medium text-sm transition-all ${reactions.like ? 'bg-green-500 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-green-50 hover:text-green-600'}"
                    data-property="${property.id}"
                    data-type="like"
                  >
                    <i class="fas fa-thumbs-up"></i>
                    <span class="hidden sm:inline">${pageState.text.likeIt}</span>
                  </button>
                  <button
                    onclick="toggleReaction('${property.id}', 'maybe')"
                    class="reaction-btn flex items-center justify-center gap-1 py-2 rounded-lg font-medium text-sm transition-all ${reactions.maybe ? 'bg-amber-500 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-amber-50 hover:text-amber-600'}"
                    data-property="${property.id}"
                    data-type="maybe"
                  >
                    <i class="fas fa-question"></i>
                    <span class="hidden sm:inline">${pageState.text.maybe}</span>
                  </button>
                  <button
                    onclick="toggleReaction('${property.id}', 'dislike')"
                    class="reaction-btn flex items-center justify-center gap-1 py-2 rounded-lg font-medium text-sm transition-all ${reactions.dislike ? 'bg-red-500 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-red-50 hover:text-red-600'}"
                    data-property="${property.id}"
                    data-type="dislike"
                  >
                    <i class="fas fa-thumbs-down"></i>
                    <span class="hidden sm:inline">${pageState.text.dontLikeIt}</span>
                  </button>
                </div>

                <button
                  onclick="showCommentModal('${property.id}')"
                  class="w-full flex items-center justify-center gap-2 py-2 rounded-lg font-medium text-sm bg-[#f04e00]/10 text-[#f04e00] hover:bg-[#f04e00]/20 transition-all"
                >
                  <i class="fas fa-comment"></i>
                  ${pageState.text.addComment}
                  ${reactions.comments.length > 0 ? `<span class="bg-[#f04e00] text-white text-xs px-2 py-0.5 rounded-full">${reactions.comments.length}</span>` : ''}
                </button>

                <!-- Comments -->
                ${reactions.comments.length > 0 ? `
                  <div class="mt-3 space-y-2">
                    ${reactions.comments.slice(0, 3).map(comment => `
                      <div class="bg-gray-50 rounded-lg p-3 text-sm">
                        <p class="text-gray-700">${comment.text}</p>
                        <p class="text-xs text-gray-400 mt-1">${formatDate(comment.created_at)}</p>
                      </div>
                    `).join('')}
                    ${reactions.comments.length > 3 ? `
                      <p class="text-xs text-gray-500 text-center">+${reactions.comments.length - 3} m√°s comentarios</p>
                    ` : ''}
                  </div>
                ` : ''}
              </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');

      // Re-apply tracking to new dynamic links
      applyTrackingToLinks();
    }

    // ===================================================================
    // REACTIONS
    // ===================================================================
    async function toggleReaction(propertyId, reactionType) {
      const currentReactions = pageState.reactions[propertyId] || { like: false, dislike: false, maybe: false, comments: [] };
      const isActive = currentReactions[reactionType];

      try {
        const response = await fetch(`${API_URL}/reaction`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            proposal_id: pageState.proposal.id,
            property_id: propertyId,
            reaction_type: reactionType,
            remove: isActive
          })
        });

        const result = await response.json();

        if (result.success) {
          pageState.reactions = result.data.reactions;
          renderProperties();
          showNotification(pageState.text.thankYou, '', 'success');
        }
      } catch (error) {
        console.error('Error toggling reaction:', error);
      }
    }

    // ===================================================================
    // COMMENTS
    // ===================================================================
    function showCommentModal(propertyId) {
      document.getElementById('commentPropertyId').value = propertyId;
      document.getElementById('commentText').value = '';
      const modal = document.getElementById('commentModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeCommentModal() {
      const modal = document.getElementById('commentModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    async function saveComment(event) {
      event.preventDefault();

      const propertyId = document.getElementById('commentPropertyId').value;
      const commentText = document.getElementById('commentText').value;

      if (!commentText.trim()) return;

      try {
        const response = await fetch(`${API_URL}/comment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            proposal_id: pageState.proposal.id,
            property_id: propertyId,
            comment_text: commentText
          })
        });

        const result = await response.json();

        if (result.success) {
          pageState.reactions = result.data.reactions;
          closeCommentModal();
          renderProperties();
          showNotification(pageState.text.thankYou, '', 'success');
        }
      } catch (error) {
        console.error('Error saving comment:', error);
      }
    }

    // ===================================================================
    // CAROUSEL
    // ===================================================================
    const carouselState = {};

    function changeSlide(carouselIndex, direction) {
      const container = document.querySelector(`[data-carousel="${carouselIndex}"]`);
      if (!container) return;

      const slides = container.querySelectorAll('.carousel-slide');
      const totalSlides = slides.length;

      if (!carouselState[carouselIndex]) {
        carouselState[carouselIndex] = 0;
      }

      let newIndex = carouselState[carouselIndex] + direction;
      if (newIndex < 0) newIndex = totalSlides - 1;
      if (newIndex >= totalSlides) newIndex = 0;

      goToSlide(carouselIndex, newIndex);
    }

    function goToSlide(carouselIndex, slideIndex) {
      const container = document.querySelector(`[data-carousel="${carouselIndex}"]`);
      if (!container) return;

      const slides = container.querySelectorAll('.carousel-slide');
      const dots = document.querySelectorAll(`.carousel-dot[data-carousel="${carouselIndex}"]`);
      const counter = document.querySelector(`.carousel-counter[data-carousel="${carouselIndex}"]`);

      carouselState[carouselIndex] = slideIndex;

      slides.forEach((slide, index) => {
        if (index === slideIndex) {
          slide.classList.remove('opacity-0');
          slide.classList.add('opacity-100');
        } else {
          slide.classList.remove('opacity-100');
          slide.classList.add('opacity-0');
        }
      });

      dots.forEach((dot, index) => {
        if (index === slideIndex) {
          dot.classList.remove('bg-white/50', 'w-2');
          dot.classList.add('bg-white', 'w-4');
        } else {
          dot.classList.remove('bg-white', 'w-4');
          dot.classList.add('bg-white/50', 'w-2');
        }
      });

      if (counter) {
        counter.textContent = slideIndex + 1;
      }
    }

    // ===================================================================
    // UTILITIES
    // ===================================================================
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString(pageState.language === 'en' ? 'en-US' : pageState.language === 'fr' ? 'fr-FR' : 'es-ES', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function showNotification(title, message, type = 'success') {
      const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
      const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-2xl z-50 flex items-start gap-3 max-w-sm animate-slide-in`;
      notification.innerHTML = `
        <i class="fas ${icon} text-xl mt-0.5"></i>
        <div class="flex-1">
          <p class="font-bold">${title}</p>
          ${message ? `<p class="text-sm opacity-90">${message}</p>` : ''}
        </div>
        <button onclick="this.parentElement.remove()" class="hover:opacity-80">
          <i class="fas fa-times"></i>
        </button>
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // ===================================================================
    // INIT
    // ===================================================================
    document.addEventListener('DOMContentLoaded', initializePage);

    // Global functions
    window.toggleReaction = toggleReaction;
    window.showCommentModal = showCommentModal;
    window.closeCommentModal = closeCommentModal;
    window.saveComment = saveComment;
    window.changeSlide = changeSlide;
    window.goToSlide = goToSlide;
  </script>

  <style>
    @keyframes slide-in {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .animate-slide-in {
      animation: slide-in 0.3s ease-out;
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</Layout>
