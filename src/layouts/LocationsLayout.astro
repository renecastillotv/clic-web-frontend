---
// src/layouts/LocationsLayout.astro
import Layout from './Layout.astro';
import PropertyCarousel from '../components/PropertyCarousel.astro';

/* Utils */
function safeArray(arr, def = []) { return Array.isArray(arr) ? arr : def; }
function safeString(str, def = '') { return typeof str === 'string' ? str : def; }
function safeObject(obj, def = {}) { return obj && typeof obj === 'object' && !Array.isArray(obj) ? obj : def; }
function safeNumber(num, def = 0) { return typeof num === 'number' && !isNaN(num) ? num : def; }

/* Props */
const { data } = Astro.props;
const language = safeString(data?.language, 'es');

/* Datos demo (luego vendrán del backend) */
const locationsData = safeObject(data);

const locations = safeObject(locationsData?.locations, {
  countries: [],
  cities: [],
  sectors: []
});

const stats = safeObject(locationsData?.stats, {
  totalCities: 0,
  totalSectors: 0,
  totalProperties: 0
});

/* Traducciones */
const text = ({
  es: {
    metaTitle: 'Ubicaciones Disponibles | CLIC',
    metaDescription: 'Explora todas las ciudades y sectores donde tenemos propiedades disponibles',
    pageTitle: 'Explora Ubicaciones',
    pageSubtitle: 'Encuentra propiedades en las mejores zonas',
    citiesTitle: 'Ciudades Principales',
    sectorsTitle: 'Sectores Destacados',
    noLocations: 'No se encontraron ubicaciones disponibles.',
    properties: 'propiedades',
    viewProperties: 'Ver propiedades',
    allCities: 'Todas las Ciudades',
    popularSectors: 'Sectores Populares'
  },
  en: {
    metaTitle: 'Available Locations | CLIC',
    metaDescription: 'Explore all cities and sectors where we have available properties',
    pageTitle: 'Explore Locations',
    pageSubtitle: 'Find properties in the best areas',
    citiesTitle: 'Main Cities',
    sectorsTitle: 'Featured Sectors',
    noLocations: 'No locations found.',
    properties: 'properties',
    viewProperties: 'View properties',
    allCities: 'All Cities',
    popularSectors: 'Popular Sectors'
  },
  fr: {
    metaTitle: 'Emplacements Disponibles | CLIC',
    metaDescription: 'Explorez toutes les villes et secteurs où nous avons des propriétés disponibles',
    pageTitle: 'Explorer les Emplacements',
    pageSubtitle: 'Trouvez des propriétés dans les meilleures zones',
    citiesTitle: 'Villes Principales',
    sectorsTitle: 'Secteurs en Vedette',
    noLocations: 'Aucun emplacement trouvé.',
    properties: 'propriétés',
    viewProperties: 'Voir les propriétés',
    allCities: 'Toutes les Villes',
    popularSectors: 'Secteurs Populaires'
  }
})[language];

/* SEO */
const rawSeo = safeObject(locationsData?.seo);
const safeSeo = {
  title: safeString(rawSeo.title) || text.metaTitle,
  description: safeString(rawSeo.description) || text.metaDescription,
  h1: safeString(rawSeo.h1) || text.pageTitle,
  h2: safeString(rawSeo.h2) || text.pageSubtitle,
  canonical_url: safeString(rawSeo.canonical_url, ''),
  ogImage: safeString(rawSeo.ogImage || rawSeo.open_graph?.image, '/og-locations.jpg'),
  keywords: safeString(rawSeo.keywords),
  hreflang: safeObject(rawSeo.hreflang),
  breadcrumbs: safeArray(rawSeo.breadcrumbs, []),
  structured_data: safeObject(rawSeo.structured_data),
  open_graph: safeObject(rawSeo.open_graph),
  twitter_card: safeObject(rawSeo.twitter_card)
};

/* Layout props */
const layoutProps = {
  title: safeSeo.title,
  description: safeSeo.description,
  ogImage: safeSeo.ogImage,
  canonical: safeSeo.canonical_url,
  keywords: safeSeo.keywords,
  hreflangData: safeSeo.hreflang || {},
  globalConfig: locationsData?.globalConfig || {},
  language,
  trackingString: locationsData?.trackingString || '',
  hotItems: locationsData?.hotItems || {},
  country: locationsData?.country || {},
  breadcrumbs: safeSeo.breadcrumbs,
  structuredData: safeSeo.structured_data,
  openGraph: safeSeo.open_graph,
  twitterCard: safeSeo.twitter_card
};

/* Obtener datos reales del backend */
const enrichedCitiesData = safeArray(locations?.enrichedCities);
const citiesData = safeArray(locations?.cities);
const sectorsData = safeArray(locations?.sectors);
const featuredBySector = safeObject(locationsData?.featuredBySector);

/* Fallback demo data solo si no hay datos del backend */
const demoCities = [
  { name: 'Santo Domingo', slug: 'santo-domingo', count: 1234 },
  { name: 'Santiago', slug: 'santiago', count: 567 },
  { name: 'Punta Cana', slug: 'punta-cana', count: 890 },
  { name: 'La Romana', slug: 'la-romana', count: 234 }
];

const demoSectors = [
  { name: 'Piantini', slug: 'piantini', count: 345 },
  { name: 'Naco', slug: 'naco', count: 234 },
  { name: 'Bella Vista', slug: 'bella-vista', count: 456 },
  { name: 'Evaristo Morales', slug: 'evaristo-morales', count: 189 }
];

/* Usar datos reales si existen, sino demo */
const displayFeaturedCities = enrichedCitiesData.length > 0 ? enrichedCitiesData : demoCities.slice(0, 4);
const displayCities = citiesData.length > 0 ? citiesData : demoCities;
const displaySectors = sectorsData.length > 0 ? sectorsData : demoSectors;
---

<Layout {...layoutProps}>
  <div class="locations-layout">

    <!-- HERO -->
    <section class="py-16 bg-gradient-to-r from-gray-900 to-gray-800 text-white">
      <div class="container mx-auto px-4 text-center">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">{safeSeo.h1}</h1>
        <p class="text-xl md:text-2xl opacity-90 max-w-3xl mx-auto mb-8">{safeSeo.h2}</p>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto mt-12">
          <div class="bg-white/10 rounded-lg p-6 backdrop-blur-sm">
            <div class="text-3xl font-bold text-[#f04e00]">{stats.totalCities || displayCities.length}</div>
            <div class="text-sm uppercase tracking-wide mt-2 opacity-80">{text.allCities}</div>
          </div>
          <div class="bg-white/10 rounded-lg p-6 backdrop-blur-sm">
            <div class="text-3xl font-bold text-[#f04e00]">{stats.totalSectors || displaySectors.length}</div>
            <div class="text-sm uppercase tracking-wide mt-2 opacity-80">{text.popularSectors}</div>
          </div>
          <div class="bg-white/10 rounded-lg p-6 backdrop-blur-sm">
            <div class="text-3xl font-bold text-[#f04e00]">{stats.totalProperties || '5,000+'}</div>
            <div class="text-sm uppercase tracking-wide mt-2 opacity-80">{text.properties}</div>
          </div>
        </div>
      </div>
    </section>

    <!-- CIUDADES PRINCIPALES -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold mb-8 text-center">{text.citiesTitle}</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          {displayFeaturedCities.map(city => {
            // Usar seo_description si tiene datos enriquecidos
            const description = city.seo_description || '';
            const hasImage = city.hasEnrichedData && city.hero_image;

            // Obtener un insight relevante de market_insights
            let mainInsight = '';
            if (city.market_insights) {
              const insights = Object.values(city.market_insights);
              mainInsight = insights[0] || '';
            }

            return (
              <a
                href={`/${city.slug}`}
                class="group bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden hover:shadow-2xl hover:border-[#f04e00] transition-all duration-300 transform hover:-translate-y-2"
              >
                {/* Imagen si existe, sino gradiente */}
                {hasImage ? (
                  <div class="aspect-[4/3] relative bg-gray-200">
                    <img
                      src={city.hero_image}
                      alt={city.name}
                      class="w-full h-full object-cover"
                      loading="lazy"
                    />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>

                    <div class="absolute bottom-0 left-0 right-0 p-6 text-white">
                      <h3 class="text-2xl font-bold mb-2">{city.name}</h3>
                      <p class="text-sm opacity-90 font-semibold">{city.count} {text.properties}</p>
                      {description && (
                        <p class="text-xs opacity-90 mt-2 line-clamp-2">{description}</p>
                      )}
                    </div>
                  </div>
                ) : (
                  <div class={`aspect-[4/3] relative ${city.color ? '' : 'bg-gradient-to-br from-blue-500 to-purple-600'}`}
                       style={city.color ? `background: linear-gradient(135deg, ${city.color}22, ${city.color}66)` : ''}>

                    {/* Icono si existe */}
                    {city.icon && (
                      <div class="absolute top-4 right-4 text-4xl opacity-30">
                        {city.icon}
                      </div>
                    )}

                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>

                    <div class="absolute bottom-0 left-0 right-0 p-6 text-white">
                      <h3 class="text-2xl font-bold mb-2">{city.name}</h3>
                      <p class="text-sm opacity-90 font-semibold">{city.count} {text.properties}</p>
                      {description && (
                        <p class="text-xs opacity-75 mt-2 line-clamp-2">{description}</p>
                      )}
                    </div>
                  </div>
                )}

                {/* Info adicional si tiene datos enriquecidos */}
                {city.hasEnrichedData && mainInsight && (
                  <div class="p-4 bg-gray-50">
                    <div class="flex items-start gap-2 text-sm text-gray-600">
                      <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      <span class="line-clamp-2">{mainInsight}</span>
                    </div>
                  </div>
                )}
              </a>
            );
          })}
        </div>
      </div>
    </section>

    <!-- SECTORES DESTACADOS -->
    <section class="py-16 bg-gray-50">
      <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold mb-8 text-center">{text.sectorsTitle}</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          {displaySectors.slice(0, 12).map(sector => (
            <a
              href={`/${sector.slug}`}
              class="bg-white rounded-lg shadow-sm border border-gray-100 p-6 hover:shadow-lg hover:border-[#f04e00] transition-all duration-300 group"
            >
              <div class="flex items-start justify-between mb-3">
                <h3 class="text-xl font-bold group-hover:text-[#f04e00] transition-colors flex-1">{sector.name}</h3>
                {sector.icon && (
                  <span class="text-2xl ml-2">{sector.icon}</span>
                )}
              </div>

              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                  </svg>
                  <span class="text-sm font-semibold text-gray-700">{sector.count} {text.properties}</span>
                </div>
                <svg class="w-5 h-5 text-[#f04e00] transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>

    <!-- CAROUSELES POR SECTOR (si hay datos) -->
    {featuredBySector && Object.keys(featuredBySector).length > 0 && (
      <div class="bg-white">
        {Object.entries(featuredBySector).map(([sectorName, properties]) => {
          // Buscar el slug correcto del sector
          const sectorInfo = displaySectors.find(s => s.name === sectorName);
          const sectorSlug = sectorInfo?.slug || sectorName.toLowerCase().replace(/\s+/g, '-');

          return properties && properties.length > 0 && (
            <section class="py-8">
              <PropertyCarousel
                title={`${language === 'es' ? 'Destacadas en' : language === 'en' ? 'Featured in' : 'En vedette à'} ${sectorName}`}
                properties={properties}
                viewAllLink={`/${sectorSlug}`}
                theme="default"
                language={language}
                country={locationsData?.country}
                loadingStrategy="lazy"
                maxVisible={6}
              />
            </section>
          );
        })}
      </div>
    )}

    <!-- CTA -->
    <section class="py-16 bg-gradient-to-r from-[#f04e00] to-[#e03d00] text-white">
      <div class="container mx-auto px-4 text-center">
        <h3 class="text-3xl font-bold mb-4">
          {language === 'es' ? '¿No encuentras la ubicación que buscas?' :
           language === 'en' ? 'Can\'t find the location you\'re looking for?' :
           'Vous ne trouvez pas l\'emplacement que vous cherchez?'}
        </h3>
        <p class="text-lg opacity-90 mb-8 max-w-2xl mx-auto">
          {language === 'es' ? 'Nuestros asesores te ayudarán a encontrar la propiedad perfecta en cualquier zona' :
           language === 'en' ? 'Our advisors will help you find the perfect property in any area' :
           'Nos conseillers vous aideront à trouver la propriété parfaite dans n\'importe quelle zone'}
        </p>
        <a
          href="/contacto"
          class="inline-block px-8 py-3 bg-white text-[#f04e00] font-semibold rounded-lg hover:bg-gray-100 transition-all duration-300 transform hover:scale-105"
        >
          {language === 'es' ? 'Contactar Asesor' :
           language === 'en' ? 'Contact Advisor' :
           'Contacter un Conseiller'}
        </a>
      </div>
    </section>

  </div>

  <!-- Structured Data -->
  {safeSeo.structured_data && (
    <script type="application/ld+json" set:html={JSON.stringify(safeSeo.structured_data)}></script>
  )}
</Layout>
