---
// src/layouts/SharedFavoritesLayout.astro - Layout para favoritos compartidos
import Layout from './Layout.astro';

// ===================================================================
// EXTRACCI√ìN DE DATOS DEL PROP
// ===================================================================

const { data } = Astro.props;
const language = data?.language || 'es';
const globalConfig = data?.globalConfig || null;
const hreflangData = data?.seo?.hreflang || {};

// ===================================================================
// TEXTOS POR IDIOMA
// ===================================================================

const TEXTS = {
  es: {
    title: 'Lista de Favoritos Compartida - CLIC Inmobiliaria',
    description: 'Ve y comenta en esta lista de propiedades favoritas compartida contigo.',
    pageTitle: 'Lista de Favoritos Compartida',
    pageSubtitle: 'Explora estas propiedades y deja tu opini√≥n',
    loading: 'Cargando lista...',
    whoAreYou: '¬øC√≥mo te llamas?',
    whoAreYouDescription: 'Introduce tu nombre para poder ver y comentar en esta lista',
    enterButton: 'Entrar a la lista',
    notFound: 'Lista no encontrada',
    notFoundDescription: 'Esta lista no existe o no est√° disponible para compartir',
    exploreButton: 'Explorar propiedades',
    listTitle: 'Lista de Favoritos',
    viewingAs: 'Viendo como:',
    propertiesCount: 'propiedades',
    addComment: 'Agregar comentario',
    commentPlaceholder: 'Escribe tu opini√≥n sobre esta propiedad...',
    saveComment: 'Guardar comentario',
    cancel: 'Cancelar',
    routes: {
      properties: '/comprar'
    }
  },
  en: {
    title: 'Shared Favorites List - CLIC Real Estate',
    description: 'View and comment on this shared favorites list.',
    pageTitle: 'Shared Favorites List',
    pageSubtitle: 'Explore these properties and leave your opinion',
    loading: 'Loading list...',
    whoAreYou: 'What\'s your name?',
    whoAreYouDescription: 'Enter your name to view and comment on this list',
    enterButton: 'Enter the list',
    notFound: 'List not found',
    notFoundDescription: 'This list does not exist or is not available for sharing',
    exploreButton: 'Explore properties',
    listTitle: 'Favorites List',
    viewingAs: 'Viewing as:',
    propertiesCount: 'properties',
    addComment: 'Add comment',
    commentPlaceholder: 'Write your opinion about this property...',
    saveComment: 'Save comment',
    cancel: 'Cancel',
    routes: {
      properties: '/en/buy'
    }
  },
  fr: {
    title: 'Liste de Favoris Partag√©e - CLIC Immobilier',
    description: 'Consultez et commentez cette liste de favoris partag√©e.',
    pageTitle: 'Liste de Favoris Partag√©e',
    pageSubtitle: 'Explorez ces propri√©t√©s et laissez votre avis',
    loading: 'Chargement de la liste...',
    whoAreYou: 'Comment vous appelez-vous?',
    whoAreYouDescription: 'Entrez votre nom pour voir et commenter cette liste',
    enterButton: 'Entrer dans la liste',
    notFound: 'Liste non trouv√©e',
    notFoundDescription: 'Cette liste n\'existe pas ou n\'est pas disponible pour le partage',
    exploreButton: 'Explorer les propri√©t√©s',
    listTitle: 'Liste de Favoris',
    viewingAs: 'Vu comme:',
    propertiesCount: 'propri√©t√©s',
    addComment: 'Ajouter un commentaire',
    commentPlaceholder: '√âcrivez votre opinion sur cette propri√©t√©...',
    saveComment: 'Enregistrer le commentaire',
    cancel: 'Annuler',
    routes: {
      properties: '/fr/acheter'
    }
  }
};

const text = TEXTS[language] || TEXTS.es;

console.log('‚úÖ SharedFavoritesLayout preparado:', {
  language,
  originalUrl: data?.originalUrl,
  queryParams: data?.queryParams
});
---

<Layout
  title={text.title}
  description={text.description}
  language={language}
  globalConfig={globalConfig}
  hreflangData={hreflangData}
>
  <!-- Hero Section -->
  <section class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 py-12 text-white relative overflow-hidden">
    <div class="absolute inset-0 opacity-10 z-0">
      <div class="absolute top-0 left-0 w-96 h-96 bg-[#f04e00] rounded-full filter blur-3xl"></div>
      <div class="absolute bottom-0 right-0 w-96 h-96 bg-blue-600 rounded-full filter blur-3xl"></div>
    </div>

    <div class="container mx-auto px-4 relative z-10">
      <div class="max-w-4xl mx-auto text-center">
        <div class="inline-flex items-center gap-2 bg-[#f04e00]/20 px-4 py-2 rounded-full mb-4">
          <i class="fas fa-share-alt text-[#f04e00]"></i>
          <span class="text-sm font-semibold">{text.listTitle}</span>
        </div>
        <h1 class="text-3xl md:text-4xl font-bold mb-3">
          {text.pageTitle}
        </h1>
        <p class="text-lg text-white/70 mb-4">
          {text.pageSubtitle}
        </p>
        <div class="inline-flex items-center gap-2 bg-white/10 backdrop-blur-md px-4 py-2 rounded-lg border border-white/20">
          <i class="fas fa-fingerprint text-[#f04e00]"></i>
          <span class="text-sm">ID:</span>
          <span id="listIdDisplay" class="font-mono font-semibold text-[#f04e00]">-</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="py-8">
    <div class="container mx-auto px-4">
      <div class="max-w-6xl mx-auto">
        
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-[#f04e00]"></div>
          <p class="mt-4 text-gray-600">{text.loading}</p>
        </div>

        <!-- Access Form -->
        <div id="accessForm" class="hidden">
          <div class="max-w-md mx-auto bg-white rounded-2xl shadow-lg p-8 text-center border border-gray-100">
            <div class="w-16 h-16 bg-[#f04e00]/10 rounded-full flex items-center justify-center mx-auto mb-6">
              <i class="fas fa-user text-[#f04e00] text-2xl"></i>
            </div>

            <h2 class="text-2xl font-bold text-gray-900 mb-3">{text.whoAreYou}</h2>
            <p class="text-gray-600 mb-6">
              {text.whoAreYouDescription}
            </p>

            <form onsubmit="joinList(event)" class="space-y-4">
              <div>
                <input
                  type="text"
                  id="visitorAlias"
                  class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#f04e00] focus:border-[#f04e00] transition-all"
                  placeholder="Ej: Mar√≠a, Pap√°, Juan..."
                  required
                  maxlength="50"
                >
              </div>

              <button type="submit" class="w-full bg-[#f04e00] text-white py-3 px-6 rounded-lg hover:bg-[#e03d00] transition-all font-semibold shadow-lg hover:shadow-xl">
                {text.enterButton}
              </button>
            </form>
          </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="text-center py-12 hidden">
          <div class="text-6xl mb-6">üòû</div>
          <h2 class="text-2xl font-bold text-gray-900 mb-4">{text.notFound}</h2>
          <p class="text-gray-600 mb-8">
            {text.notFoundDescription}
          </p>
          <a 
            href={text.routes.properties}
            class="inline-block bg-[#f04e00] text-white px-6 py-3 rounded-lg hover:bg-[#e03d00] transition-colors font-semibold"
          >
            {text.exploreButton}
          </a>
        </div>

        <!-- Visitor Content -->
        <div id="visitorContent" class="hidden">
          
          <!-- Visitor Info -->
          <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
              <div>
                <h2 class="text-xl font-bold text-gray-900 mb-1">{text.listTitle}</h2>
                <div class="text-sm text-gray-600">
                  {text.viewingAs} <span id="visitorName" class="font-semibold text-[#f04e00]">-</span>
                </div>
              </div>
              
              <div class="text-sm text-gray-500">
                <span id="propertiesCount">0</span> {text.propertiesCount}
              </div>
            </div>
          </div>

          <!-- Properties Grid -->
          <div id="propertiesGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Properties will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Comment Modal -->
  <div id="reactionModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4" onclick="if(event.target === this) closeReactionModal()">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full relative animate-fadeIn border border-gray-100">
      <button onclick="closeReactionModal()" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-all">
        <i class="fas fa-times text-lg"></i>
      </button>

      <div class="p-6">
        <div class="flex items-center gap-3 mb-6">
          <div class="p-3 bg-[#f04e00]/10 rounded-xl">
            <i class="fas fa-comment text-[#f04e00] text-xl"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-900">{text.addComment}</h3>
        </div>

        <form onsubmit="saveComment(event)" class="space-y-4">
          <div>
            <label for="commentText" class="block text-sm font-medium text-gray-700 mb-2">
              {text.commentPlaceholder}
            </label>
            <textarea
              id="commentText"
              class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#f04e00] focus:border-[#f04e00] transition-all resize-none"
              placeholder={text.commentPlaceholder}
              rows="5"
              required
              maxlength="500"
            ></textarea>
            <p class="text-xs text-gray-500 mt-1">M√°ximo 500 caracteres</p>
          </div>

          <div class="flex gap-3">
            <button
              type="button"
              onclick="closeReactionModal()"
              class="flex-1 px-5 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all font-medium"
            >
              {text.cancel}
            </button>
            <button
              type="submit"
              class="flex-1 px-5 py-3 bg-[#f04e00] text-white rounded-lg hover:bg-[#e03d00] transition-all font-semibold shadow-lg hover:shadow-xl"
            >
              <i class="fas fa-paper-plane mr-2"></i>
              {text.saveComment}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</Layout>

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }

  @keyframes slide-in {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  .animate-fadeIn {
    animation: fadeIn 0.2s ease-out;
  }

  .animate-slide-in {
    animation: slide-in 0.3s ease-out;
  }

  .property-card {
    transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
  }

  .property-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .reaction-btn {
    transition: all 0.2s ease-in-out;
  }

  .reaction-btn:hover {
    transform: scale(1.05);
  }

  .reaction-btn:active {
    transform: scale(0.95);
  }
</style>

<script>
  // ===== P√ÅGINA DE FAVORITOS PARA VISITANTES =====
  
  let pageState = {
    listId: null,
    properties: [],
    reactions: {},
    visitorInfo: null,
    isLoading: false,
    currentPropertyId: null
  };

  // Obtener listId desde la URL (query parameter)
  function getListIdFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('id');
  }

  // Generar device ID √∫nico para visitante
  function generateVisitorDeviceId() {
    let deviceId = localStorage.getItem('visitor_device_id');
    if (!deviceId) {
      deviceId = 'VIS-' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
      localStorage.setItem('visitor_device_id', deviceId);
    }
    return deviceId;
  }

  // ===== INICIALIZACI√ìN =====
  async function initializePage() {
    // Obtener ID de la lista desde URL
    pageState.listId = getListIdFromUrl();
    
    if (!pageState.listId || !pageState.listId.startsWith('DEV-')) {
      console.error('‚ùå ID de lista inv√°lido:', pageState.listId);
      showErrorState();
      return;
    }

    console.log('üöÄ Inicializando p√°gina de visitante para:', pageState.listId);
    document.getElementById('listIdDisplay').textContent = pageState.listId;
    
    const visitorDeviceId = generateVisitorDeviceId();
    console.log('üì± Visitor Device ID:', visitorDeviceId);

    // Verificar si es el mismo creador de la lista
    if (window.simpleFavoritesManager) {
      const info = window.simpleFavoritesManager.getDeviceInfo();
      if (info.deviceId === pageState.listId) {
        // Es el creador, redirigir a su p√°gina personal
        console.log('üë§ Es el creador, redirigiendo...');
        window.location.href = '/favoritos';
        return;
      }
    }

    // Verificar si ya est√° registrado como visitante
    const storedVisitor = localStorage.getItem(`visitor_${pageState.listId}`);
    if (storedVisitor) {
      try {
        pageState.visitorInfo = JSON.parse(storedVisitor);
        console.log('‚úÖ Visitante ya registrado:', pageState.visitorInfo);
        await loadListContent();
        return;
      } catch (e) {
        console.warn('‚ö†Ô∏è Error parsing stored visitor info');
        localStorage.removeItem(`visitor_${pageState.listId}`);
      }
    }

    // Mostrar formulario de acceso
    showAccessForm();
  }

  // ===== MOSTRAR ESTADOS =====
  function showAccessForm() {
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('accessForm').classList.remove('hidden');
    document.getElementById('errorState').classList.add('hidden');
    document.getElementById('visitorContent').classList.add('hidden');
  }

  function showErrorState() {
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('accessForm').classList.add('hidden');
    document.getElementById('errorState').classList.remove('hidden');
    document.getElementById('visitorContent').classList.add('hidden');
  }

  function showVisitorContent() {
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('accessForm').classList.add('hidden');
    document.getElementById('errorState').classList.add('hidden');
    document.getElementById('visitorContent').classList.remove('hidden');
  }

  // ===== UNIRSE A LA LISTA =====
  async function joinList(event) {
    event.preventDefault();
    
    const alias = document.getElementById('visitorAlias').value.trim();
    if (!alias) return;

    const visitorDeviceId = generateVisitorDeviceId();

    try {
      const response = await fetch(`https://clic-api-neon.vercel.app/api/favorites/visitor`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          list_id: pageState.listId,
          visitor_device_id: visitorDeviceId,
          alias: alias
        })
      });

      const data = await response.json();

      if (!response.ok) {
        if (response.status === 404) {
          showErrorState();
          return;
        }
        throw new Error(data.error || 'Error joining list');
      }

      // Guardar info del visitante
      pageState.visitorInfo = {
        alias: alias,
        deviceId: visitorDeviceId,
        joinedAt: new Date().toISOString()
      };

      localStorage.setItem(`visitor_${pageState.listId}`, JSON.stringify(pageState.visitorInfo));

      console.log('‚úÖ Successfully joined list as:', alias);
      await loadListContent();

    } catch (error) {
      console.error('‚ùå Error joining list:', error);
      alert('Error al acceder a la lista. Int√©ntalo de nuevo.');
    }
  }

  // ===== CARGAR CONTENIDO DE LA LISTA =====
  async function loadListContent() {
    if (pageState.isLoading) return;
    
    pageState.isLoading = true;
    console.log('üì¶ Cargando contenido de la lista...');

    try {
      // Cargar propiedades
      const propertiesResponse = await fetch(`https://clic-api-neon.vercel.app/api/favorites/details/${pageState.listId}`, {
        headers: {
          'Content-Type': 'application/json'
        }
      });
      const propertiesData = await propertiesResponse.json();

      if (!propertiesResponse.ok || !propertiesData.success) {
        throw new Error(propertiesData.error || 'Error loading properties');
      }

      pageState.properties = propertiesData.data?.properties || [];

      // Cargar reacciones
      const reactionsResponse = await fetch(`https://clic-api-neon.vercel.app/api/favorites/summary/${pageState.listId}`, {
        headers: {
          'Content-Type': 'application/json'
        }
      });
      const reactionsData = await reactionsResponse.json();

      if (reactionsResponse.ok && reactionsData.success) {
        pageState.reactions = reactionsData.data || {};
      }

      showVisitorContent();
      updateVisitorInfo();
      renderProperties();

    } catch (error) {
      console.error('‚ùå Error loading list content:', error);
      showErrorState();
    } finally {
      pageState.isLoading = false;
    }
  }

  // ===== ACTUALIZAR INFO DEL VISITANTE =====
  function updateVisitorInfo() {
    if (pageState.visitorInfo) {
      document.getElementById('visitorName').textContent = pageState.visitorInfo.alias;
    }
    document.getElementById('propertiesCount').textContent = pageState.properties.length;
  }

  // ===== RENDERIZAR PROPIEDADES =====
  function renderProperties() {
    const grid = document.getElementById('propertiesGrid');
    
    if (pageState.properties.length === 0) {
      grid.innerHTML = `
        <div class="col-span-full text-center py-12 text-gray-500">
          <div class="text-4xl mb-4">üì¶</div>
          <p>Esta lista no tiene propiedades a√∫n</p>
        </div>
      `;
      return;
    }

    grid.innerHTML = pageState.properties.map((property, propertyIndex) => {
      const reactions = pageState.reactions[property.id] || { likes: [], dislikes: [], comments: [] };
      // Ahora likes y dislikes son arrays de objetos con visitor_device_id
      const userLiked = Array.isArray(reactions.likes) && reactions.likes.some(r => r.visitor_device_id === pageState.visitorInfo?.deviceId);
      const userDisliked = Array.isArray(reactions.dislikes) && reactions.dislikes.some(r => r.visitor_device_id === pageState.visitorInfo?.deviceId);

      // Obtener todas las im√°genes disponibles
      const allImages = [];
      if (property.imagen) allImages.push(property.imagen);
      if (property.imagenes && Array.isArray(property.imagenes)) {
        property.imagenes.forEach(img => {
          if (img && !allImages.includes(img)) allImages.push(img);
        });
      }
      if (allImages.length === 0) {
        allImages.push('https://via.placeholder.com/400x300/e5e7eb/9ca3af?text=Sin+Imagen');
      }

      // URL de la propiedad
      const propertyUrl = property.url || `/${property.operacion === 'alquiler' ? 'alquilar' : 'comprar'}/${property.slug}`;

      return `
        <div class="property-card bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden hover:shadow-xl transition-all duration-300">
          <!-- Carrusel de Im√°genes -->
          <div class="relative aspect-[4/3] overflow-hidden bg-gradient-to-br from-gray-100 to-gray-200 group">
            <div class="carousel-container relative w-full h-full" data-carousel="${propertyIndex}">
              ${allImages.map((img, imgIndex) => `
                <img
                  src="${img}"
                  alt="${property.titulo || property.name} - Imagen ${imgIndex + 1}"
                  class="carousel-slide absolute inset-0 w-full h-full object-cover transition-opacity duration-300 ${imgIndex === 0 ? 'opacity-100' : 'opacity-0'}"
                  data-index="${imgIndex}"
                  loading="lazy"
                  onerror="this.src='https://via.placeholder.com/400x300/e5e7eb/9ca3af?text=Sin+Imagen';"
                />
              `).join('')}

              ${allImages.length > 1 ? `
                <!-- Botones de navegaci√≥n -->
                <button
                  onclick="event.stopPropagation(); changeSlide(${propertyIndex}, -1)"
                  class="absolute left-2 top-1/2 -translate-y-1/2 p-2 bg-black/50 hover:bg-black/70 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10"
                >
                  <i class="fas fa-chevron-left text-sm"></i>
                </button>
                <button
                  onclick="event.stopPropagation(); changeSlide(${propertyIndex}, 1)"
                  class="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-black/50 hover:bg-black/70 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10"
                >
                  <i class="fas fa-chevron-right text-sm"></i>
                </button>

                <!-- Indicadores -->
                <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1.5 z-10">
                  ${allImages.map((_, dotIndex) => `
                    <button
                      onclick="event.stopPropagation(); goToSlide(${propertyIndex}, ${dotIndex})"
                      class="carousel-dot w-2 h-2 rounded-full transition-all ${dotIndex === 0 ? 'bg-white w-4' : 'bg-white/50 hover:bg-white/80'}"
                      data-carousel="${propertyIndex}"
                      data-dot="${dotIndex}"
                    ></button>
                  `).join('')}
                </div>

                <!-- Contador de fotos -->
                <div class="absolute top-3 right-3 bg-black/60 text-white px-2 py-1 rounded text-xs font-medium z-10">
                  <i class="fas fa-camera mr-1"></i>
                  <span class="carousel-counter" data-carousel="${propertyIndex}">1</span>/${allImages.length}
                </div>
              ` : ''}
            </div>

            ${property.tipo && property.tipo !== 'Propiedad' ? `
              <span class="absolute top-3 left-3 bg-[#f04e00] text-white px-3 py-1.5 rounded-lg text-xs font-semibold shadow-lg z-10">
                ${property.tipo}
              </span>
            ` : ''}
          </div>

          <!-- Contenido -->
          <div class="p-5">
            <!-- Precio destacado -->
            ${property.precio ? `
              <div class="mb-3">
                <p class="text-xl font-bold text-[#f04e00]">${property.precio}</p>
              </div>
            ` : ''}

            <!-- C√≥digo y enlace -->
            <div class="flex items-center justify-between mb-2">
              ${property.code ? `
                <div class="text-xs text-gray-400 font-mono">
                  ref.: ${property.code}
                </div>
              ` : '<div></div>'}
              <a
                href="${propertyUrl}"
                target="_blank"
                rel="noopener noreferrer"
                class="text-xs text-[#f04e00] hover:text-[#e03d00] font-medium flex items-center gap-1"
                onclick="event.stopPropagation()"
              >
                <i class="fas fa-external-link-alt"></i>
                Ver detalles
              </a>
            </div>

            <!-- Ubicaci√≥n -->
            <div class="flex items-center gap-1 mb-2">
              <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
              <p class="text-sm text-gray-600 truncate">${property.sector || 'Ubicaci√≥n no especificada'}</p>
            </div>

            <!-- T√≠tulo -->
            <h3 class="font-bold text-lg text-gray-900 line-clamp-2 leading-tight mb-4">
              ${property.titulo || property.name || 'Propiedad sin nombre'}
            </h3>

            <!-- Caracter√≠sticas con FontAwesome -->
            <div class="flex items-center justify-center gap-4 mb-4 pb-4 border-b border-gray-100">
              ${(property.habitaciones || 0) > 0 ? `
              <span class="flex items-center gap-1.5">
                <i class="fas fa-bed text-[#f04e00] text-sm"></i>
                <span class="font-semibold text-sm text-gray-700">${property.habitaciones}</span>
              </span>
              ` : ''}

              ${(property.banos || 0) > 0 ? `
              <span class="flex items-center gap-1.5">
                <i class="fas fa-bath text-[#f04e00] text-sm"></i>
                <span class="font-semibold text-sm text-gray-700">${property.banos}</span>
              </span>
              ` : ''}

              ${(property.metros || property.metros_construidos || 0) > 0 ? `
              <span class="flex items-center gap-1.5">
                <i class="fas fa-th-large text-[#f04e00] text-sm"></i>
                <span class="font-semibold text-sm text-gray-700">${property.metros || property.metros_construidos} m¬≤</span>
              </span>
              ` : ''}

              ${(property.estacionamientos || 0) > 0 ? `
              <span class="flex items-center gap-1.5">
                <i class="fas fa-car text-[#f04e00] text-sm"></i>
                <span class="font-semibold text-sm text-gray-700">${property.estacionamientos}</span>
              </span>
              ` : ''}
            </div>

            <!-- Reacciones -->
            <div class="pt-4">
              <div class="flex items-center gap-2 mb-4">
                <button
                  onclick="toggleReaction('${property.id}', 'like')"
                  class="reaction-btn flex-1 flex items-center justify-center gap-2 py-2.5 rounded-lg font-medium text-sm transition-all ${userLiked ? 'bg-green-500 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-green-50 hover:text-green-600'}"
                >
                  <i class="fas fa-thumbs-up"></i>
                  <span class="font-bold">${reactions.likes.length}</span>
                </button>

                <button
                  onclick="toggleReaction('${property.id}', 'dislike')"
                  class="reaction-btn flex-1 flex items-center justify-center gap-2 py-2.5 rounded-lg font-medium text-sm transition-all ${userDisliked ? 'bg-red-500 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-red-50 hover:text-red-600'}"
                >
                  <i class="fas fa-thumbs-down"></i>
                  <span class="font-bold">${reactions.dislikes.length}</span>
                </button>

                <button
                  onclick="showCommentModal('${property.id}')"
                  class="reaction-btn flex-1 flex items-center justify-center gap-2 py-2.5 rounded-lg font-medium text-sm bg-[#f04e00] text-white hover:bg-[#e03d00] transition-all shadow-md"
                >
                  <i class="fas fa-comment"></i>
                  <span class="font-bold">${reactions.comments.length}</span>
                </button>
              </div>

              <!-- Comentarios recientes -->
              ${reactions.comments.length > 0 ? `
                <div class="space-y-2">
                  ${reactions.comments.slice(0, 2).map(comment => `
                    <div class="bg-gray-50 rounded-lg p-3">
                      <div class="flex items-start gap-2">
                        <div class="w-8 h-8 rounded-full bg-[#f04e00] flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                          ${(comment.visitor_alias || 'U').charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                          <p class="font-semibold text-sm text-gray-900">${comment.visitor_alias || 'Usuario'}</p>
                          <p class="text-sm text-gray-600 mt-0.5">${comment.comment_text}</p>
                        </div>
                      </div>
                    </div>
                  `).join('')}

                  ${reactions.comments.length > 2 ? `
                    <button onclick="showCommentModal('${property.id}')" class="text-xs text-[#f04e00] hover:text-[#e03d00] font-medium">
                      Ver los ${reactions.comments.length} comentarios
                    </button>
                  ` : ''}
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // ===== MANEJAR REACCIONES =====
  async function toggleReaction(propertyId, reactionType) {
    if (!pageState.visitorInfo) return;

    try {
      const response = await fetch(`https://clic-api-neon.vercel.app/api/favorites/reaction`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          list_id: pageState.listId,
          property_id: propertyId,
          visitor_device_id: pageState.visitorInfo.deviceId,
          visitor_alias: pageState.visitorInfo.alias,
          reaction_type: reactionType
        })
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Error saving reaction');
      }

      // Recargar reacciones
      await loadReactions();
      renderProperties();

    } catch (error) {
      console.error('Error saving reaction:', error);
      showNotification('Error', 'No se pudo guardar tu reaccion. Intentalo de nuevo.', 'error');
    }
  }

  function showNotification(title, message, type = 'success') {
    const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-2xl z-50 flex items-start gap-3 max-w-sm animate-slide-in`;
    notification.innerHTML = `
      <i class="fas ${icon} text-xl mt-0.5"></i>
      <div class="flex-1">
        <p class="font-bold">${title}</p>
        <p class="text-sm opacity-90">${message}</p>
      </div>
      <button onclick="this.parentElement.remove()" class="hover:opacity-80">
        <i class="fas fa-times"></i>
      </button>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 4000);
  }

  async function loadReactions() {
    try {
      const response = await fetch(`https://clic-api-neon.vercel.app/api/favorites/summary/${pageState.listId}`, {
        headers: {
          'Content-Type': 'application/json'
        }
      });
      const data = await response.json();

      if (response.ok && data.success) {
        pageState.reactions = data.data || {};
      }
    } catch (error) {
      console.error('Error loading reactions:', error);
    }
  }

  // ===== MODAL DE COMENTARIOS =====
  function showCommentModal(propertyId) {
    pageState.currentPropertyId = propertyId;
    document.getElementById('reactionModal').classList.remove('hidden');
    document.getElementById('reactionModal').classList.add('flex');
    document.getElementById('commentText').focus();
  }

  function closeReactionModal() {
    document.getElementById('reactionModal').classList.add('hidden');
    document.getElementById('reactionModal').classList.remove('flex');
    document.getElementById('commentText').value = '';
    pageState.currentPropertyId = null;
  }

  async function saveComment(event) {
    event.preventDefault();

    const commentText = document.getElementById('commentText').value.trim();
    if (!commentText || !pageState.currentPropertyId || !pageState.visitorInfo) return;

    try {
      const response = await fetch(`https://clic-api-neon.vercel.app/api/favorites/comment`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          list_id: pageState.listId,
          property_id: pageState.currentPropertyId,
          visitor_device_id: pageState.visitorInfo.deviceId,
          visitor_alias: pageState.visitorInfo.alias,
          comment_text: commentText
        })
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        throw new Error(data.error || 'Error saving comment');
      }

      closeReactionModal();
      await loadReactions();
      renderProperties();

    } catch (error) {
      console.error('‚ùå Error saving comment:', error);
      showNotification('Error', 'No se pudo guardar tu comentario. Int√©ntalo de nuevo.', 'error');
    }
  }

  // ===== FUNCIONES DEL CARRUSEL =====
  const carouselState = {};

  function changeSlide(carouselIndex, direction) {
    const container = document.querySelector(`[data-carousel="${carouselIndex}"]`);
    if (!container) return;

    const slides = container.querySelectorAll('.carousel-slide');
    const totalSlides = slides.length;

    if (!carouselState[carouselIndex]) {
      carouselState[carouselIndex] = 0;
    }

    // Calcular nuevo √≠ndice
    let newIndex = carouselState[carouselIndex] + direction;
    if (newIndex < 0) newIndex = totalSlides - 1;
    if (newIndex >= totalSlides) newIndex = 0;

    goToSlide(carouselIndex, newIndex);
  }

  function goToSlide(carouselIndex, slideIndex) {
    const container = document.querySelector(`[data-carousel="${carouselIndex}"]`);
    if (!container) return;

    const slides = container.querySelectorAll('.carousel-slide');
    const dots = document.querySelectorAll(`.carousel-dot[data-carousel="${carouselIndex}"]`);
    const counter = document.querySelector(`.carousel-counter[data-carousel="${carouselIndex}"]`);

    // Actualizar estado
    carouselState[carouselIndex] = slideIndex;

    // Actualizar slides
    slides.forEach((slide, index) => {
      if (index === slideIndex) {
        slide.classList.remove('opacity-0');
        slide.classList.add('opacity-100');
      } else {
        slide.classList.remove('opacity-100');
        slide.classList.add('opacity-0');
      }
    });

    // Actualizar dots
    dots.forEach((dot, index) => {
      if (index === slideIndex) {
        dot.classList.remove('bg-white/50', 'w-2');
        dot.classList.add('bg-white', 'w-4');
      } else {
        dot.classList.remove('bg-white', 'w-4');
        dot.classList.add('bg-white/50', 'w-2');
      }
    });

    // Actualizar contador
    if (counter) {
      counter.textContent = slideIndex + 1;
    }
  }

  // ===== INICIALIZACI√ìN =====
  document.addEventListener('DOMContentLoaded', function() {
    initializePage();
  });

  // Funciones globales
  window.joinList = joinList;
  window.toggleReaction = toggleReaction;
  window.showCommentModal = showCommentModal;
  window.closeReactionModal = closeReactionModal;
  window.saveComment = saveComment;
  window.changeSlide = changeSlide;
  window.goToSlide = goToSlide;
</script>